<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8B0000">
    <meta name="description" content="Calculadora para volume e custo de madeira serrada">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="CalcMadeira">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>Calculadora de Volume de Madeira</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
        }

        .header {
            background-color: #8B0000;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-name {
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .page-title {
            font-size: 1.3rem;
            margin: 0;
        }

        .home-btn {
            color: white;
            font-size: 1.2rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
            text-decoration: none;
        }

        .home-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .menu-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .menu-panel.active {
            left: 0;
        }

        .menu-header {
            background-color: #8B0000;
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-avatar {
            width: 50px;
            height: 50px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .menu-user-info {
            flex: 1;
        }

        .menu-user-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .menu-user-email {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .menu-items {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            gap: 15px;
        }

        .menu-item:hover {
            background-color: #f5f5f5;
        }

        .menu-item i {
            width: 20px;
            color: #8B0000;
        }

        .menu-item.logout {
            color: #dc3545;
            cursor: pointer;
        }

        .menu-item.logout i {
            color: #dc3545;
        }

        .menu-item.logout:hover {
            background-color: #fff5f5;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        .calculator {
            padding: 20px;
            background-color: white;
            max-width: 600px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .input-group label {
            width: 120px;
        }

        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .input-group .unit {
            width: 50px;
            padding-left: 10px;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .result-item {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-item h3 {
            font-size: 0.9rem;
            color: #666;
        }

        .result-item p {
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .add-button {
            background-color: #8B0000;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 1rem;
            cursor: pointer;
        }

        .list {
            margin-top: 20px;
        }

        .list-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #8B0000;
        }

        .list-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            position: relative;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: #f8f8f8;
        }

        .delete-btn {
            display: none;
            background: none;
            border: none;
            color: #ff0000;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }

        .list-item:hover .delete-btn {
            display: block;
        }

        .total-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
            color: #8B0000;
        }

        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: white;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .action-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: #8B0000;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Feedback styles */
        .feedback {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .feedback.success {
            background-color: #4CAF50;
        }

        .feedback.error {
            background-color: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive improvements */
        @media (max-width: 480px) {
            .input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .input-group label {
                margin-bottom: 5px;
            }
            
            .input-group input {
                width: 100%;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }

            .list-header, .list-item, .total-row {
                grid-template-columns: 1fr 1fr 1fr 1fr 0.5fr;
                font-size: 0.9em;
            }
        }

        /* Estilos para mobile */
        @media (max-width: 600px) {
            .input-group input[type="number"],
            .input-group input[type="text"] {
                font-size: 16px; /* Evita zoom no iOS */
                padding: 12px;
                width: 100%;
                -webkit-appearance: none; /* Remove setas no iOS */
                appearance: none;
            }

            /* Remove setas do input number */
            .input-group input[type="number"]::-webkit-inner-spin-button,
            .input-group input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Ajuste para o input de pre√ßo */
            .currency-input {
                font-size: 16px;
                padding: 12px;
                width: 100%;
            }

            .delete-btn {
                width: 44px; /* √Årea de toque m√≠nima recomendada */
                height: 44px;
                font-size: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #ff4444;
                color: white;
                border: none;
                border-radius: 8px;
                touch-action: manipulation;
            }

            .list-item {
                padding: 15px 10px;
                position: relative;
            }

            .total-row {
                background-color: #f8f8f8;
                font-weight: bold;
                padding: 15px 10px;
                margin-top: 10px;
                border-top: 2px solid #ddd;
            }

            /* Melhorar visualiza√ß√£o da tabela em mobile */
            .list-header, .list-item, .total-row {
                display: grid;
                grid-template-columns: 2fr 1fr 1.5fr 1.5fr 44px;
                gap: 10px;
                align-items: center;
            }
        }

        /* Feedback visual */
        .feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }

        .feedback.error {
            background-color: #f44336;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }

        .list-controls {
            display: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Estilos para autocomplete */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ccc;
            border-top: none;
            z-index: 99;
            background-color: white;
            width: calc(100% - 20px);
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .input-group {
            position: relative;
            margin-bottom: 10px;
        }
        
        /* Resto dos estilos existentes */
        
        /* Estilos para autocomplete */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-results div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .autocomplete-results div:hover {
            background-color: #f5f5f5;
        }

        .species-card {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
            <div class="menu-avatar">üë§</div>
            <div class="menu-user-info">
                <div class="menu-user-name">Usu√°rio Padr√£o</div>
                <div class="menu-user-email">usuario@email.com</div>
            </div>
        </div>
        <div class="menu-items">
            <a href="perfil.html" class="menu-item">
                <i class="fas fa-user"></i>
                <span>Meu Perfil</span>
            </a>
            <a href="orcamentos.html" class="menu-item">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Or√ßamentos</span>
            </a>
            <a href="configuracoes.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Configura√ß√µes</span>
            </a>
            <a href="notificacoes.html" class="menu-item">
                <i class="fas fa-bell"></i>
                <span>Notifica√ß√µes</span>
            </a>
            <a href="ajuda.html" class="menu-item">
                <i class="fas fa-question-circle"></i>
                <span>Ajuda</span>
            </a>
            <div class="menu-item logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </div>
        </div>
    </div>

    <div class="header">
        <button class="menu-btn" id="menuBtn" aria-label="Abrir menu">‚ò∞</button>
        <div class="header-content">
            <div class="app-name">Sistema de Gest√£o de Madeiras Serrada</div>
            <h1 class="page-title">Calculadora</h1>
        </div>
        <div class="header-actions">
        <button class="refresh-btn" aria-label="Limpar dados">‚ü≥</button>
            <a href="calc.html" class="home-btn" aria-label="P√°gina inicial"><i class="fas fa-home"></i></a>
        </div>
    </div>

    <div class="calculator">
        <!-- Informa√ß√µes adicionais -->
        <div class="client-info">
            <div class="input-group">
                <label for="clientName">Cliente:</label>
                <input type="text" id="clientName" placeholder="Nome do cliente" autocomplete="off">
                <div class="autocomplete-items" id="clientAutocomplete"></div>
            </div>
            <div class="input-group">
                <label for="clientContact">Contato:</label>
                <input type="text" id="clientContact" placeholder="(00) 0 0000-0000" autocomplete="off">
            </div>
            <div class="input-group">
                <label for="species">Esp√©cie:</label>
                <input type="text" id="species" placeholder="Tipo de madeira" autocomplete="off">
                <div class="autocomplete-items" id="speciesAutocomplete"></div>
            </div>
        </div>

        <!-- Calculadora de Madeira -->
        <div class="input-group">
            <label>Espessura</label>
            <input type="number" 
                   id="thickness" 
                   placeholder="cm"
                   inputmode="decimal"
                   pattern="[0-9]*"
                   step="0.1"
                   min="0">
            <span class="unit">cm</span>
        </div>
        <div class="input-group">
            <label>Largura</label>
            <input type="number" 
                   id="width" 
                   placeholder="cm"
                   inputmode="decimal"
                   pattern="[0-9]*"
                   step="0.1"
                   min="0">
            <span class="unit">cm</span>
        </div>
        <div class="input-group">
            <label>Comprimento</label>
            <input type="number" 
                   id="length" 
                   placeholder="cm"
                   inputmode="decimal"
                   pattern="[0-9]*"
                   step="0.1"
                   min="0">
            <span class="unit">cm</span>
        </div>
        <div class="input-group">
            <label>Quantidade</label>
            <input type="number" 
                   id="quantity" 
                   placeholder="0"
                   inputmode="numeric"
                   pattern="[0-9]*"
                   min="0">
            <span class="unit" id="quantityUnit">Pe√ßas</span>
        </div>
        <div class="input-group">
            <label>Quantidade Pacote</label>
            <input type="number" 
                   id="packageQuantity" 
                   placeholder="1"
                   inputmode="numeric"
                   pattern="[0-9]*"
                   value="1"
                   min="1"
                   oninput="updateQuantityLabel()">
            <span class="unit">Pacote</span>
        </div>
        <div class="input-group">
            <label for="price">Pre√ßo por m¬≥:</label>
            <input type="text" 
                   id="price" 
                   inputmode="decimal"
                   pattern="[0-9]*"
                   class="currency-input" 
                   placeholder="R$ 0,00">
        </div>

        <div class="results">
            <div class="results-grid">
                <div class="result-item">
                    <h3>VOLUME</h3>
                    <p id="volume">0,000m¬≥</p>
                </div>
                <div class="result-item">
                    <h3>VOLUME TOTAL</h3>
                    <p id="totalVolume">0,000m¬≥</p>
                </div>
                <div class="result-item">
                    <h3>CUSTO</h3>
                    <p id="cost">R$ 0,00</p>
                </div>
            </div>
        </div>

        <button class="add-button" id="addButton" onclick="testDirectClick()">ADICIONAR √Ä LISTA</button>

        <button class="add-button" style="background-color: #4CAF50; margin-top: 10px;" onclick="saveAsQuote()">SALVAR OR√áAMENTO</button>

        <div class="list">
            <div class="list-container">
                <div class="list-header">
                    <div>TAMANHO</div>
                    <div>PE√áAS</div>
                    <div>VOLUME</div>
                    <div>PRE√áO</div>
                    <div></div>
                </div>
                <div id="itemsList"></div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-button">+</button>
        <button class="action-button">‚éò</button>
        <button class="action-button">‚òê</button>
    </div>

    <script src="auth.js"></script>
    <script src="pwa-updater.js"></script>
    <script src="update-checker.js"></script>
    <script>
        // Verificar autentica√ß√£o e plano ativo
        if (!isUserLoggedIn()) {
            window.location.href = 'index.html';
        } 
        /* Bloqueio de plano temporariamente removido para testes
        else if (!isPlanActive()) {
            window.location.href = 'planos.html';
        }
        */

        // Fun√ß√µes de fallback para auth.js caso n√£o seja carregado
        if (typeof isUserLoggedIn !== 'function') {
            console.warn("Fun√ß√£o isUserLoggedIn n√£o encontrada. Usando fallback.");
            function isUserLoggedIn() {
                // Vers√£o simplificada para testes
                return true;
            }
        }

        if (typeof logoutUser !== 'function') {
            console.warn("Fun√ß√£o logoutUser n√£o encontrada. Usando fallback.");
            function logoutUser() {
                console.log("Logout simulado");
                localStorage.removeItem('woodList');
                window.location.href = 'index.html';
            }
        }

        function logout() {
            logoutUser();
            window.location.href = 'index.html';
        }

        // Verificar se o app est√° instalado
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Fun√ß√£o para instalar o app
        async function installApp() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('Usu√°rio aceitou a instala√ß√£o do app');
            }
            deferredPrompt = null;
        }

        // Formatadores
        const formatters = {
            volume: new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            }),
            currency: new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            })
        };

        // Fun√ß√£o para calcular
        function calculate() {
            try {
                // Obter todos os valores dos campos de entrada
                const thickness = parseFloat(document.getElementById('thickness').value) || 0;
                const width = parseFloat(document.getElementById('width').value) || 0;
                const length = parseFloat(document.getElementById('length').value) || 0;
                const quantity = parseInt(document.getElementById('quantity').value) || 0;
                const packageQuantity = parseInt(document.getElementById('packageQuantity').value) || 1;
                
                // Obter o pre√ßo e converter para n√∫mero
                const priceInput = document.getElementById('price').value;
                const price = parseFloat(priceInput.replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;

                console.log("Valores para c√°lculo:", { thickness, width, length, quantity, packageQuantity, price });

                // Calcular volume unit√°rio em m¬≥
                const volumeUnit = (thickness * width * length) / 1000000;
                
                // Calcular volume total considerando quantidade e pacotes
                const totalQuantity = quantity * packageQuantity;
                const volumeTotal = volumeUnit * totalQuantity;
                
                // Calcular custo total
                const cost = volumeTotal * price;

                console.log("Resultados calculados:", { volumeUnit, volumeTotal, cost });

                // Atualizar os elementos na interface
                document.getElementById('volume').textContent = formatters.volume.format(volumeUnit).replace('.', ',') + 'm¬≥';
                document.getElementById('totalVolume').textContent = formatters.volume.format(volumeTotal).replace('.', ',') + 'm¬≥';
                document.getElementById('cost').textContent = formatters.currency.format(cost);
            } catch (error) {
                console.error("Erro ao calcular:", error);
            }
        }

        // Utility functions
        function sanitizeInput(input) {
            return input.replace(/[^0-9,.]/g, '');
        }

        function validateData(data) {
            return {
                ...data,
                volume: Math.max(0, parseFloat(data.volume) || 0),
                cost: Math.max(0, parseFloat(data.cost) || 0)
            };
        }

        // Fun√ß√£o para mostrar feedback
        function showFeedback(message, type = 'success') {
            const feedback = document.createElement('div');
            feedback.className = `feedback ${type}`;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 3000);
        }

        // Fun√ß√£o para validar inputs
        function validateInputs() {
            console.log("Iniciando valida√ß√£o de inputs");
            
            try {
            const width = document.getElementById('width').value;
            const thickness = document.getElementById('thickness').value;
            const length = document.getElementById('length').value;
            const quantity = document.getElementById('quantity').value;
            const price = document.getElementById('price').value;

                console.log("Valores para valida√ß√£o:", { width, thickness, length, quantity, price });

                if (!width || parseFloat(width) <= 0) {
                    console.log("Largura inv√°lida");
                showFeedback('Por favor, insira uma largura v√°lida', 'error');
                return false;
            }

                if (!thickness || parseFloat(thickness) <= 0) {
                    console.log("Espessura inv√°lida");
                showFeedback('Por favor, insira uma espessura v√°lida', 'error');
                return false;
            }

                if (!length || parseFloat(length) <= 0) {
                    console.log("Comprimento inv√°lido");
                showFeedback('Por favor, insira um comprimento v√°lido', 'error');
                return false;
            }

                if (!quantity || parseInt(quantity) <= 0) {
                    console.log("Quantidade inv√°lida");
                showFeedback('Por favor, insira uma quantidade v√°lida', 'error');
                return false;
            }

                if (!price || price === 'R$ 0,00' || price === 'R$ ,00') {
                    console.log("Pre√ßo inv√°lido");
                showFeedback('Por favor, insira um pre√ßo v√°lido', 'error');
                return false;
            }

                console.log("Valida√ß√£o bem-sucedida");
            return true;
            } catch (error) {
                console.error("Erro durante a valida√ß√£o:", error);
                showFeedback('Erro ao validar os dados', 'error');
                return false;
            }
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Storage functions
        function saveList() {
            const items = Array.from(document.querySelectorAll('.list-item')).map(item => {
                // Usar os dados armazenados nos atributos data- para informa√ß√µes precisas
                // Formatar as dimens√µes usando o thickness, width e length originais
                const thickness = item.dataset.thickness;
                const width = item.dataset.width;
                const length = item.dataset.length;
                const formattedSize = thickness && width && length ? 
                    `${thickness} X ${width} X ${length}` : 
                    item.children[0].textContent;
                
                return {
                    size: formattedSize,
                    quantity: item.dataset.quantity || item.children[1].textContent,
                volume: item.children[2].textContent,
                    price: item.children[3].textContent,
                    packageQuantity: item.dataset.packageQuantity || 1,
                    totalQuantity: item.dataset.totalQuantity || item.children[1].textContent,
                    species: item.dataset.species || ''
                };
            });
            
            // Salvar a lista atual
            localStorage.setItem('woodList', JSON.stringify(items));
            console.log("Lista salva com sucesso:", items);
        }

        function loadList() {
            const items = JSON.parse(localStorage.getItem('woodList') || '[]');
            items.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                
                // Guardar informa√ß√µes adicionais como atributos data-
                if (item.packageQuantity) {
                    listItem.dataset.packageQuantity = item.packageQuantity;
                }
                listItem.dataset.quantity = item.quantity;
                
                // Caso tenha totalQuantity salvo, usar, sen√£o calcular
                const totalQuantity = item.totalQuantity || 
                                     (parseInt(item.quantity) * parseInt(item.packageQuantity || 1));
                listItem.dataset.totalQuantity = totalQuantity;
                
                // Determinar o que mostrar na coluna de quantidade
                let quantityDisplay = item.quantity;
                if (parseInt(item.packageQuantity) > 1) {
                    quantityDisplay = totalQuantity;
                }
                
                // Guardar a esp√©cie se existir
                if (item.species) {
                    listItem.dataset.species = item.species;
                }
                
                // Remover a tag de esp√©cie do HTML
                listItem.innerHTML = `
                    <div>${item.size}</div>
                    <div>${quantityDisplay}</div>
                    <div>${item.volume}</div>
                    <div>${item.price}</div>
                    <button class="delete-btn" aria-label="Excluir item">√ó</button>
                `;

                // Adicionar evento de exclus√£o
                const deleteBtn = listItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevenir propaga√ß√£o do evento
                    if (confirm('Tem certeza que deseja remover este item?')) {
                        listItem.remove();
                        saveList();
                        calcularTotal();
                        showFeedback('Item removido com sucesso!');
                    }
                });

                document.getElementById('itemsList').appendChild(listItem);
            });
            calcularTotal();
        }

        // Carregar dados do perfil
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("DOMContentLoaded iniciado");
                
                // Configurar formata√ß√£o de telefone
                const contactInput = document.getElementById('clientContact');
                contactInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    let formattedValue = '';
                    
                    if (value.length > 0) {
                        formattedValue += '(' + value.substring(0, Math.min(2, value.length));
                    }
                    
                    if (value.length > 2) {
                        formattedValue += ') ';
                        
                        // Verificar se √© celular (tem 9 na frente)
                        if (value.length > 2 && value.charAt(2) === '9') {
                            formattedValue += value.charAt(2) + ' ';
                            
                            if (value.length > 3) {
                                formattedValue += value.substring(3, Math.min(7, value.length));
                            }
                            
                            if (value.length > 7) {
                                formattedValue += '-' + value.substring(7, Math.min(11, value.length));
                            }
                        } else {
                            // Telefone fixo
                            formattedValue += value.substring(2, Math.min(6, value.length));
                            
                            if (value.length > 6) {
                                formattedValue += '-' + value.substring(6, Math.min(10, value.length));
                            }
                        }
                    }
                    
                    e.target.value = formattedValue;
                });
                console.log("Formata√ß√£o de telefone configurada");
                
                // Configurar autocomplete para cliente e esp√©cie
                // Inicializar lista de clientes se n√£o existir
                if (!localStorage.getItem('clients')) {
                    localStorage.setItem('clients', JSON.stringify([]));
                }
                
                // Inicializar lista de esp√©cies se n√£o existir
                if (!localStorage.getItem('species')) {
                    localStorage.setItem('species', JSON.stringify([]));
                }
                
                // Configurar autocompletar para Cliente
                const clientInput = document.getElementById('clientName');
                const clientAutocomplete = document.getElementById('clientAutocomplete');
                
                clientInput.addEventListener('input', function() {
                    const term = this.value.trim().toLowerCase();
                    const clients = JSON.parse(localStorage.getItem('clients')) || [];
                    
                    // Limpar sugest√µes anteriores
                    clientAutocomplete.innerHTML = '';
                    
                    if (!term) return;
                    
                    // Filtrar clientes que correspondem ao termo
                    const matchingClients = clients.filter(client => 
                        client.toLowerCase().includes(term)
                    );
                    
                    // Mostrar at√© 5 sugest√µes
                    matchingClients.slice(0, 5).forEach(client => {
                        const item = document.createElement('div');
                        item.textContent = client;
                        item.addEventListener('click', function() {
                            clientInput.value = client;
                            clientAutocomplete.innerHTML = '';
                            clientAutocomplete.style.display = 'none';
                        });
                        clientAutocomplete.appendChild(item);
                    });
                    
                    // Mostrar o container de autocompletar
                    if (matchingClients.length > 0) {
                        clientAutocomplete.style.display = 'block';
                    } else {
                        clientAutocomplete.style.display = 'none';
                    }
                });
                
                // Configurar autocompletar para Esp√©cie
                const speciesInput = document.getElementById('species');
                const speciesAutocomplete = document.getElementById('speciesAutocomplete');
                
                speciesInput.addEventListener('input', function() {
                    const term = this.value.trim().toLowerCase();
                    const speciesList = JSON.parse(localStorage.getItem('species')) || [];
                    
                    // Limpar sugest√µes anteriores
                    speciesAutocomplete.innerHTML = '';
                    
                    if (!term) return;
                    
                    // Filtrar esp√©cies que correspondem ao termo
                    const matchingSpecies = speciesList.filter(species => 
                        species.toLowerCase().includes(term)
                    );
                    
                    // Mostrar at√© 5 sugest√µes
                    matchingSpecies.slice(0, 5).forEach(species => {
                        const item = document.createElement('div');
                        item.textContent = species;
                        item.addEventListener('click', function() {
                            speciesInput.value = species;
                            speciesAutocomplete.innerHTML = '';
                            speciesAutocomplete.style.display = 'none';
                        });
                        speciesAutocomplete.appendChild(item);
                    });
                    
                    // Mostrar o container de autocompletar
                    if (matchingSpecies.length > 0) {
                        speciesAutocomplete.style.display = 'block';
                    } else {
                        speciesAutocomplete.style.display = 'none';
                    }
                });
                
                // Salvar cliente e esp√©cie quando perder o foco
                clientInput.addEventListener('blur', function() {
                    const clientName = this.value.trim();
                    if (clientName) {
                        saveClientToLocalStorage(clientName);
                    }
                    // Ocultar sugest√µes ap√≥s um pequeno atraso (para permitir o clique)
                    setTimeout(() => {
                        clientAutocomplete.style.display = 'none';
                    }, 200);
                });
                
                speciesInput.addEventListener('blur', function() {
                    const speciesName = this.value.trim();
                    if (speciesName) {
                        saveSpeciesToLocalStorage(speciesName);
                    }
                    // Ocultar sugest√µes ap√≥s um pequeno atraso (para permitir o clique)
                    setTimeout(() => {
                        speciesAutocomplete.style.display = 'none';
                    }, 200);
                });
                
                // Fun√ß√£o para salvar cliente no localStorage
                function saveClientToLocalStorage(clientName) {
                    const clients = JSON.parse(localStorage.getItem('clients')) || [];
                    if (!clients.includes(clientName)) {
                        clients.push(clientName);
                        localStorage.setItem('clients', JSON.stringify(clients));
                    }
                }
                
                // Fun√ß√£o para salvar esp√©cie no localStorage
                function saveSpeciesToLocalStorage(speciesName) {
                    const speciesList = JSON.parse(localStorage.getItem('species')) || [];
                    if (!speciesList.includes(speciesName)) {
                        speciesList.push(speciesName);
                        localStorage.setItem('species', JSON.stringify(speciesList));
                    }
                }
                console.log("Autocompletar configurado para cliente e esp√©cie");
                
                // Verificar autentica√ß√£o - TEMPOR√ÅRIO: remover verifica√ß√£o para teste
                let bypass = true; // Vari√°vel tempor√°ria para contornar verifica√ß√£o
                if (!isUserLoggedIn() && !bypass) {
                    console.log("Usu√°rio n√£o est√° logado, redirecionando");
                    window.location.href = 'index.html';
                    return;
                }
                console.log("Verifica√ß√£o de autentica√ß√£o conclu√≠da ou ignorada");

                // Verificar se est√° editando um or√ßamento
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                
                if (editId) {
                    console.log("Carregando or√ßamento para edi√ß√£o: " + editId);
                    loadQuoteForEditing(editId);
                } else {
                    // Carregar lista normal
                    console.log("Carregando lista normal");
                    loadList();
                }

                // Inicializar formatador de moeda
                initializeCurrencyInput();
                console.log("Formatador de moeda inicializado");

                // Inicializar a label de quantidade
                updateQuantityLabel();
                console.log("Label de quantidade inicializada");

                // Carregar menus e informa√ß√µes do usu√°rio
                loadUserInfo();
                console.log("Informa√ß√µes do usu√°rio carregadas");

                // Adicionar eventos
                setupEvents();
                console.log("Eventos configurados");
                
                // For√ßar c√°lculo inicial ap√≥s um pequeno atraso para garantir que todos os elementos est√£o carregados
                setTimeout(() => {
                    console.log("Executando c√°lculo inicial ap√≥s carregamento da p√°gina");
                    calculate();
                }, 500);
                
                // Verifica√ß√£o adicional para o bot√£o de adicionar
                const addButton = document.getElementById('addButton');
                if (addButton) {
                    console.log("Bot√£o de adicionar encontrado, verificando evento");
                    
                    // Verificar se o evento j√° foi adicionado
                    const eventsAdded = addButton.getAttribute('data-events-added');
                    if (!eventsAdded) {
                        console.log("Adicionando evento de clique novamente");
                        addButton.addEventListener('click', function() {
                            console.log("Evento alternativo de clique executado");
                            
                if (!validateInputs()) {
                                console.log("Valida√ß√£o falhou no evento alternativo");
                    return;
                }

                const width = document.getElementById('width').value;
                const thickness = document.getElementById('thickness').value;
                const length = document.getElementById('length').value;
                const quantity = document.getElementById('quantity').value;
                            const packageQuantity = document.getElementById('packageQuantity').value;
                            const totalQuantity = quantity * packageQuantity;
                const price = document.getElementById('price').value;
                            const species = document.getElementById('species').value.trim();

                            const volume = (width * thickness * length * totalQuantity) / 1000000;
                const cost = volume * parseFloat(price.replace(/[^0-9,.]/g, '').replace(',', '.'));

                const item = document.createElement('div');
                item.className = 'list-item';
                            
                            let sizeInfo = `${thickness} X ${width} X ${length}`;
                            
                            item.dataset.width = width;
                            item.dataset.thickness = thickness;
                            item.dataset.length = length;
                            item.dataset.quantity = quantity;
                            item.dataset.packageQuantity = packageQuantity;
                            if (species) {
                                item.dataset.species = species;
                            }
                            item.dataset.totalQuantity = totalQuantity;
                            item.dataset.price = price.replace(/[^0-9,.]/g, '').replace(',', '.');
                            
                item.innerHTML = `
                                <div>${sizeInfo}</div>
                    <div>${quantity}</div>
                    <div>${volume.toFixed(3).replace('.', ',')}m¬≥</div>
                    <div>${formatters.currency.format(cost)}</div>
                    <div>
                                    <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                    </div>
                                ${species ? `<div class="species-tag" style="position: absolute; top: 2px; right: 40px; font-size: 10px; background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px; color: #666;">${species}</div>` : ''}
                `;
                            
                            if (species) {
                                item.style.position = 'relative';
                            }

                document.getElementById('itemsList').appendChild(item);
                            calcularTotal();
                saveList();
                showFeedback('Item adicionado com sucesso!', 'success');

                // Limpar campos
                document.getElementById('width').value = '';
                document.getElementById('thickness').value = '';
                document.getElementById('length').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('price').value = 'R$ 0,00';
                document.getElementById('thickness').focus();
                        });
                        addButton.setAttribute('data-events-added', 'true');
                        console.log("Evento alternativo adicionado com sucesso");
                    } else {
                        console.log("Eventos j√° est√£o configurados no bot√£o");
                    }
                } else {
                    console.error("Bot√£o de adicionar n√£o encontrado!");
                }
            } catch (error) {
                console.error("Erro durante o carregamento da p√°gina:", error);
            }
        });

        // Adicionar vari√°vel global para ID do or√ßamento em edi√ß√£o
        let editingQuoteId = null;

        // Fun√ß√£o para carregar or√ßamento para edi√ß√£o
        function loadQuoteForEditing(id) {
            // Definir o ID do or√ßamento em edi√ß√£o
            editingQuoteId = id;
            
            // Obter o ID do usu√°rio atual ou criar um tempor√°rio
            const userId = localStorage.getItem('currentUserId') || ('user_' + Date.now());
            
            // Salvar ID do usu√°rio se n√£o existir
            if (!localStorage.getItem('currentUserId')) {
                localStorage.setItem('currentUserId', userId);
                console.log("ID de usu√°rio tempor√°rio criado:", userId);
            }
            
            const quotes = JSON.parse(localStorage.getItem(`quotes_${userId}`) || '[]');
            const quote = quotes.find(q => q.id === id);
            
            if (!quote) {
                showFeedback('Or√ßamento n√£o encontrado', 'error');
                loadList(); // Carregar lista normal
                return;
            }
            
            console.log("Carregando or√ßamento para edi√ß√£o:", quote);
            
            // Preencher dados do cliente
            document.getElementById('clientName').value = quote.clientName;
            document.getElementById('clientContact').value = quote.clientContact || '';
            
            // Preencher esp√©cie se existir
            if (quote.species) {
                document.getElementById('species').value = quote.species;
            }
            
            // Limpar lista atual
            document.getElementById('itemsList').innerHTML = '';
            
            // Adicionar itens do or√ßamento
            quote.items.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                
                // Guardar informa√ß√µes adicionais como atributos data-
                if (item.packageQuantity) {
                    listItem.dataset.packageQuantity = item.packageQuantity;
                }
                listItem.dataset.quantity = item.quantity;
                
                // Caso tenha totalQuantity salvo, usar, sen√£o calcular
                const totalQuantity = item.totalQuantity || 
                                     (parseInt(item.quantity) * parseInt(item.packageQuantity || 1));
                listItem.dataset.totalQuantity = totalQuantity;
                
                // Determinar o que mostrar na coluna de quantidade
                let quantityDisplay = item.quantity;
                if (parseInt(item.packageQuantity) > 1) {
                    quantityDisplay = totalQuantity;
                }
                
                // Formatar as dimens√µes com X mai√∫sculo
                let sizeInfo = item.size;
                if (sizeInfo.includes('x')) {
                    // Substituir 'x' por ' X ' - primeiro criando um array com as partes e depois juntando
                    const parts = sizeInfo.split('x');
                    sizeInfo = parts.join(' X ');
                }
                
                // Guardar a esp√©cie, mas n√£o mostrar visualmente
                if (item.species) {
                    listItem.dataset.species = item.species;
                }

                // Remover a tag visual de esp√©cie do HTML
                listItem.innerHTML = `
                    <div>${sizeInfo}</div>
                    <div>${quantityDisplay}</div>
                    <div>${item.volume}</div>
                    <div>${item.price}</div>
                    <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                `;

                document.getElementById('itemsList').appendChild(listItem);
            });
            
            calcularTotal();
            showFeedback('Or√ßamento carregado para edi√ß√£o', 'success');
        }

        // Setup de eventos
        function setupEvents() {
            try {
                console.log("Iniciando setupEvents");
                
                // Evento para calcular em tempo real
                const inputs = document.querySelectorAll('#thickness, #width, #length, #quantity, #packageQuantity, #price');
                inputs.forEach(input => {
                    // Limpar eventos anteriores
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    
                    // Adicionar evento diretamente, sem debounce para garantir atualiza√ß√£o imediata
                    newInput.addEventListener('input', function() {
                        console.log(`Input alterado: ${newInput.id}`);
                        calculate();
                    });
                });
                console.log("Eventos de c√°lculo em tempo real configurados");

                // Atualizar label de quantidade quando mudar o valor de pacotes
                const packageQuantityInput = document.getElementById('packageQuantity');
                if (packageQuantityInput) {
                    packageQuantityInput.addEventListener('input', function() {
                        updateQuantityLabel();
                        calculate();
                    });
                }
                console.log("Evento de atualiza√ß√£o de label configurado");

                // Inicializar formatador de moeda
                initializeCurrencyInput();
                console.log("Formatador de moeda configurado");

                // Bot√£o de atualizar com confirma√ß√£o
                const refreshBtn = document.querySelector('.refresh-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                            localStorage.removeItem('woodList');
                            document.getElementById('itemsList').innerHTML = '';
                            calcularTotal();
                            showFeedback('Dados limpos com sucesso!');
                        }
                    });
                }
                console.log("Evento do bot√£o refresh configurado");
                
                // Executar c√°lculo inicial
                calculate();
            } catch (error) {
                console.error("Erro ao configurar eventos:", error);
            }
        }

        // Fun√ß√£o de teste para verificar se o problema est√° no evento ou na implementa√ß√£o
        function testDirectClick() {
            console.log("Bot√£o adicionar clicado");
            
            // Chama a fun√ß√£o principal diretamente sem alertas
            try {
                handleAddButtonClick();
            } catch (e) {
                console.error("Erro durante a adi√ß√£o de item:", e);
            }
        }

        // Fun√ß√£o separada para lidar com o clique no bot√£o adicionar
        function handleAddButtonClick() {
            console.log("Fun√ß√£o handleAddButtonClick iniciada");
            
            if (!validateInputs()) {
                console.log("Valida√ß√£o falhou");
                return;
            }

            const width = document.getElementById('width').value;
            const thickness = document.getElementById('thickness').value;
            const length = document.getElementById('length').value;
            const quantity = document.getElementById('quantity').value;
            const packageQuantity = document.getElementById('packageQuantity').value;
            const totalQuantity = quantity * packageQuantity;
            const price = document.getElementById('price').value;
            const species = document.getElementById('species').value.trim();

            console.log("Valores dos campos:", { width, thickness, length, quantity, packageQuantity, totalQuantity, species });

            // C√°lculos
            const volume = (width * thickness * length * totalQuantity) / 1000000;
            const cost = volume * parseFloat(price.replace(/[^0-9,.]/g, '').replace(',', '.'));
            console.log("Volume e custo calculados:", { volume, cost });

            // Criar o elemento
            const item = document.createElement('div');
            item.className = 'list-item';
            
            // Dados simplificados para exibi√ß√£o na tabela - agora com "X" mai√∫sculo
            let sizeInfo = `${thickness} X ${width} X ${length}`;
            
            // Guardar a informa√ß√£o completa nos atributos data- para uso ao salvar
            item.dataset.width = width;
            item.dataset.thickness = thickness;
            item.dataset.length = length;
            item.dataset.quantity = quantity;
            item.dataset.packageQuantity = packageQuantity;
            if (species) {
                item.dataset.species = species;
            }
            item.dataset.totalQuantity = totalQuantity;
            item.dataset.price = price.replace(/[^0-9,.]/g, '').replace(',', '.');
            
            // Exibir a quantidade total (quantidade √ó quantidade por pacote)
            let quantityDisplay = quantity;
            if (parseInt(packageQuantity) > 1) {
                quantityDisplay = `${totalQuantity}`;
            }
            
            // Remover a tag visual de esp√©cie do HTML
            item.innerHTML = `
                <div>${sizeInfo}</div>
                <div>${quantityDisplay}</div>
                <div>${volume.toFixed(3).replace('.', ',')}m¬≥</div>
                <div>${formatters.currency.format(cost)}</div>
                <div>
                    <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                </div>
            `;

            const itemsList = document.getElementById('itemsList');
            if (!itemsList) {
                console.error("Elemento itemsList n√£o encontrado!");
                return;
            }

            try {
                // Adicionar o item √† lista
                itemsList.appendChild(item);
                console.log("Item adicionado √† lista com sucesso");
                
                // Atualizar totais
                calcularTotal();
                console.log("Totais recalculados");
                
                // Salvar lista
                saveList();
                
                // Mostrar feedback visual sem popup
                showFeedback('Item adicionado com sucesso!', 'success');

                // Limpar campos
                document.getElementById('width').value = '';
                document.getElementById('thickness').value = '';
                document.getElementById('length').value = '';
                document.getElementById('quantity').value = '1';
                // N√£o limpar packageQuantity, que mant√©m o √∫ltimo valor usado
                document.getElementById('price').value = 'R$ 0,00';

                // Focar no campo de espessura
                document.getElementById('thickness').focus();
                console.log("Campos limpos e foco definido");
            } catch (error) {
                console.error("Erro ao processar adi√ß√£o de item:", error);
            }
        }

        // Carregar informa√ß√µes do usu√°rio
        function loadUserInfo() {
            const menuInfo = localStorage.getItem('menuInfo');
            if (menuInfo) {
                const { name, email } = JSON.parse(menuInfo);
                document.querySelector('.menu-user-name').textContent = name;
                document.querySelector('.menu-user-email').textContent = email;
            }
        }

        // Atualizar estat√≠sticas do usu√°rio
        function updateUserStats(type, amount) {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                
                switch(type) {
                    case 'calculation':
                        userData.totalCalculations = (userData.totalCalculations || 0) + 1;
                        userData.totalVolume = (userData.totalVolume || 0) + (amount || 0);
                        break;
                    case 'quotes':
                        userData.totalQuotes = (userData.totalQuotes || 0) + 1;
                        break;
                    default:
                        console.warn("Tipo de estat√≠stica desconhecido:", type);
                }
                
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log("Estat√≠sticas do usu√°rio atualizadas:", userData);
            } catch (error) {
                console.error("Erro ao atualizar estat√≠sticas:", error);
            }
        }

        // Atualizar a fun√ß√£o calcularTotal
        function calcularTotal() {
            const items = document.querySelectorAll('.list-item');
            let totalPieces = 0;
            let totalVolume = 0;
            let totalCost = 0;
            
            // Mapa para contar esp√©cies (mantemos para funcionalidades internas, mas n√£o mostraremos)
            const speciesMap = new Map();

            // Calcular totais em uma √∫nica passagem
            items.forEach(item => {
                // Extrair quantidade considerando pacotes
                let pieces = 0;
                const quantityText = item.children[1].textContent;
                
                // Verificar se h√° informa√ß√£o de pacotes (formato: "X pacotes (Y pe√ßas)")
                const totalPiecesMatch = quantityText.match(/\((\d+) pe√ßas\)/);
                if (totalPiecesMatch && totalPiecesMatch[1]) {
                    // Se tem informa√ß√£o sobre pe√ßas totais, usar diretamente
                    pieces = parseInt(totalPiecesMatch[1]);
                } else {
                    // Caso contr√°rio, usar a quantidade direta
                    pieces = parseInt(quantityText);
                }
                
                const volume = parseFloat(item.children[2].textContent.replace(',', '.'));
                const cost = parseFloat(item.children[3].textContent.replace('R$', '').replace('.', '').replace(',', '.'));

                // Contabilizar esp√©cie para o resumo (mantemos para funcionalidades internas)
                const species = item.dataset.species || "";
                if (species) {
                    if (speciesMap.has(species)) {
                        speciesMap.set(species, speciesMap.get(species) + 1);
                    } else {
                        speciesMap.set(species, 1);
                    }
                }

                totalPieces += pieces;
                totalVolume += volume;
                totalCost += cost;
            });

            // Remover total anterior se existir
            const oldTotal = document.querySelector('.total-row');
            if (oldTotal) {
                oldTotal.remove();
            }

            // Adicionar nova linha de total apenas se houver itens
            if (items.length > 0) {
                // Obter esp√©cie mais comum (apenas para armazenamento interno, n√£o mostraremos na interface)
                let mainSpecies = "";
                let maxCount = 0;
                speciesMap.forEach((count, species) => {
                    if (count > maxCount) {
                        maxCount = count;
                        mainSpecies = species;
                    }
                });
                
                const totalRow = document.createElement('div');
                totalRow.className = 'total-row';
                
                // Adicionar classe para destacar melhor o total
                totalRow.style.fontWeight = "bold";
                totalRow.style.fontSize = "1.1em";
                totalRow.style.backgroundColor = "#f3f3f3";
                totalRow.style.border = "1px solid #ddd";
                totalRow.style.borderRadius = "4px";
                totalRow.style.padding = "10px 10px";
                totalRow.style.marginTop = "15px";
                
                // Adicionar atributo data-species para manter o valor mas n√£o exibir visualmente
                if (mainSpecies) {
                    totalRow.dataset.species = mainSpecies;
                }
                
                totalRow.innerHTML = `
                    <div>TOTAL</div>
                    <div>${totalPieces} pe√ßas</div>
                    <div>${totalVolume.toFixed(3).replace('.', ',')}m¬≥</div>
                    <div>R$ ${totalCost.toFixed(2).replace('.', ',')}</div>
                    <div></div>
                `;
                document.getElementById('itemsList').appendChild(totalRow);
            }
        }

        // Bot√µes de a√ß√£o
        document.querySelectorAll('.action-button').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.textContent;
                switch(action) {
                    case '+':
                        // Gerar relat√≥rio diretamente
                        generateReport();
                        break;
                    case '‚éò':
                        // Compartilhar
                        shareList();
                        break;
                    case '‚òê':
                        // Copiar
                        copiarLista();
                        break;
                }
            });
        });

        // Fun√ß√£o para compartilhar
        function shareList() {
            const items = document.querySelectorAll('.list-item');
            if (items.length === 0) {
                showFeedback('N√£o h√° itens para compartilhar.', 'error');
                return;
            }

            try {
                // Buscar dados do usu√°rio e da empresa
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const companyName = user.company || 'Nome da Empresa';
                const companyPhone = user.phone || 'Telefone n√£o informado';
                const companyLogo = localStorage.getItem('companyLogo') || '';

                // Criar um elemento tempor√°rio para o relat√≥rio
                const reportDiv = document.createElement('div');
                reportDiv.style.position = 'fixed';
                reportDiv.style.left = '-9999px';
                document.body.appendChild(reportDiv);

                // Criar o conte√∫do do relat√≥rio
                let reportContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <div style="width: 150px; flex-shrink: 0;">
                                ${companyLogo ? `<img src="${companyLogo}" alt="Logo" style="max-width: 100%; height: auto; max-height: 100px; object-fit: contain;">` : '<div style="width: 150px; height: 100px; background-color: #f8f8f8; display: flex; align-items: center; justify-content: center; color: #666;">Sem Logo</div>'}
                            </div>
                            <div style="flex: 1;">
                                <h2 style="color: #333; margin: 0 0 10px 0; font-size: 24px;">${companyName}</h2>
                                <p style="color: #666; margin: 0; font-size: 16px;">${companyPhone}</p>
                            </div>
                        </div>
                        <h2 style="color: #8B0000; margin-bottom: 20px;">Relat√≥rio de Madeira</h2>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #8B0000; color: white;">
                                    <th style="padding: 10px; text-align: left;">Tamanho</th>
                                    <th style="padding: 10px; text-align: right;">Pe√ßas</th>
                                    <th style="padding: 10px; text-align: right;">Volume</th>
                                    <th style="padding: 10px; text-align: right;">Pre√ßo</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Adicionar itens
                items.forEach(item => {
                    reportContent += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${item.children[0].textContent}</td>
                            <td style="padding: 10px; text-align: right;">${item.children[1].textContent}</td>
                            <td style="padding: 10px; text-align: right;">${item.children[2].textContent}</td>
                            <td style="padding: 10px; text-align: right;">${item.children[3].textContent}</td>
                        </tr>
                    `;
                });

                // Adicionar total
                const totalRow = document.querySelector('.total-row');
                if (totalRow) {
                    reportContent += `
                        <tr style="background-color: #f8f8f8; font-weight: bold;">
                            <td style="padding: 10px;">TOTAL</td>
                            <td style="padding: 10px; text-align: right;">${totalRow.children[1].textContent}</td>
                            <td style="padding: 10px; text-align: right;">${totalRow.children[2].textContent}</td>
                            <td style="padding: 10px; text-align: right;">${totalRow.children[3].textContent}</td>
                        </tr>
                    `;
                }

                reportContent += `
                            </tbody>
                        </table>
                        <div style="margin-top: 20px; text-align: center; color: #666;">
                            Gerado em ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;

                reportDiv.innerHTML = reportContent;

                // Usar html2canvas para converter o conte√∫do em imagem
                html2canvas(reportDiv).then(canvas => {
                    canvas.toBlob(blob => {
                        if (!blob) {
                            showFeedback('Erro ao gerar a imagem.', 'error');
                            return;
                        }

                        const file = new File([blob], 'relatorio_madeira.png', { type: 'image/png' });
                        
                        if (navigator.share) {
                            navigator.share({
                                title: 'Relat√≥rio de Madeira',
                                text: 'Relat√≥rio detalhado de c√°lculos de madeira',
                                files: [file]
                            }).catch(error => {
                                console.error('Erro ao compartilhar:', error);
                                downloadImage(blob);
                            });
                        } else {
                            downloadImage(blob);
                        }
                    }, 'image/png');
                }).catch(error => {
                    console.error('Erro ao gerar relat√≥rio:', error);
                    showFeedback('Erro ao gerar o relat√≥rio. Tente novamente.', 'error');
                }).finally(() => {
                    document.body.removeChild(reportDiv);
                });
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                showFeedback('Erro ao gerar o relat√≥rio. Tente novamente.', 'error');
            }
        }

        // Fun√ß√£o auxiliar para download da imagem
        function downloadImage(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio_madeira.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showFeedback('Relat√≥rio baixado com sucesso!');
        }

        // Fun√ß√£o para copiar a lista
        function copiarLista() {
            const items = document.querySelectorAll('.list-item');
            if (items.length === 0) {
                alert('N√£o h√° itens para copiar.');
                return;
            }

            let texto = 'Lista de Madeira Serrada:\n\n';
            items.forEach(item => {
                texto += `Tamanho: ${item.children[0].textContent}\n`;
                texto += `Pe√ßas: ${item.children[1].textContent}\n`;
                texto += `Volume: ${item.children[2].textContent}\n`;
                texto += `Pre√ßo: ${item.children[3].textContent}\n\n`;
            });

            const totalRow = document.querySelector('.total-row');
            if (totalRow) {
                texto += `TOTAL:\n`;
                texto += `Pe√ßas: ${totalRow.children[1].textContent}\n`;
                texto += `Volume: ${totalRow.children[2].textContent}\n`;
                texto += `Pre√ßo: ${totalRow.children[3].textContent}\n`;
            }

            copiarParaAreaTransferencia(texto);
            alert('Lista copiada para a √°rea de transfer√™ncia!');
        }

        // Fun√ß√£o auxiliar para copiar texto
        function copiarParaAreaTransferencia(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Menu functionality
        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        const overlay = document.getElementById('overlay');

        function toggleMenu() {
            menuPanel.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = menuPanel.classList.contains('active') ? 'hidden' : '';
        }

        menuBtn.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);

        // Fechar menu ao clicar em um link
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.tagName === 'A') {
                item.addEventListener('click', () => {
                    toggleMenu();
                });
            }
        });

        // Logout functionality
        document.querySelector('.menu-item.logout').addEventListener('click', function() {
            logoutUser();
            window.location.href = 'index.html';
        });

        // Fun√ß√£o para excluir item (touch-friendly)
        function deleteItem(element) {
            if (confirm('Tem certeza que deseja remover este item?')) {
                element.closest('.list-item').remove();
                saveList();
                calcularTotal();
                showFeedback('Item removido com sucesso!');
            }
        }

        function generateReport() {
            const items = document.querySelectorAll('.list-item');
            if (items.length === 0) {
                showFeedback('Adicione itens √† lista antes de gerar o relat√≥rio', 'error');
                return;
            }

            // Buscar dados do usu√°rio e da empresa
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const companyName = user.company || 'Nome da Empresa';
            const companyPhone = user.phone || 'Telefone n√£o informado';
            const companyAddress = user.address || 'Endere√ßo n√£o informado';
            const companyEmail = user.email || 'Email n√£o informado';
            const companyCNPJ = user.cnpj || 'CNPJ n√£o informado';
            const companyLogo = localStorage.getItem('companyLogo') || '';

            // Obter informa√ß√µes do cliente
            let clientName = document.getElementById('clientName').value.trim();
            const clientContact = document.getElementById('clientContact').value.trim();
            
            // Se o cliente n√£o for informado, usar "Consumidor Final"
            if (!clientName) {
                clientName = "Consumidor Final";
            }

            // Gerar n√∫mero √∫nico para o or√ßamento
            const quoteNumber = 'OR√á-' + Math.floor(Date.now() / 1000).toString().slice(-6);
            const formattedDate = new Date().toLocaleDateString('pt-BR');
            
            // Preparar relat√≥rio condensado
            const reportWindow = window.open('', '_blank');
            const reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Or√ßamento - ${clientName}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
                        
                        :root {
                            --primary-color: #8B0000;
                            --secondary-color: #f5f5f5;
                            --text-color: #333;
                            --border-color: #ddd;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Roboto', Arial, sans-serif;
                            margin: 0;
                            padding: 15px;
                            color: var(--text-color);
                            font-size: 12px;
                            line-height: 1.4;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                        }
                        
                        .compact-header {
                            display: flex;
                            justify-content: space-between;
                            border-bottom: 1px solid var(--primary-color);
                            padding-bottom: 8px;
                            margin-bottom: 10px;
                        }
                        
                        .logo-container {
                            width: 120px;
                        }
                        
                        .logo {
                            max-width: 100%;
                            max-height: 60px;
                        }
                        
                        .company-info {
                            flex: 1;
                            padding-left: 15px;
                        }
                        
                        .company-info h1 {
                            font-size: 18px;
                            color: var(--primary-color);
                            margin-bottom: 4px;
                        }
                        
                        .company-info p {
                            margin: 0;
                            font-size: 10px;
                            line-height: 1.3;
                        }
                        
                        .document-details {
                            text-align: right;
                            font-size: 10px;
                        }
                        
                        .document-details h2 {
                            font-size: 14px;
                            color: var(--primary-color);
                            margin-bottom: 4px;
                        }
                        
                        .client-section {
                            background-color: var(--secondary-color);
                            padding: 8px;
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            font-size: 11px;
                        }
                        
                        .client-info, .quote-info {
                            flex: 1;
                        }
                        
                        .subtitle {
                            font-weight: 700;
                            color: var(--primary-color);
                            font-size: 11px;
                            margin-bottom: 4px;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 10px;
                        }
                        
                        th {
                            background-color: var(--primary-color);
                            color: white;
                            font-weight: 500;
                            text-align: left;
                            padding: 5px 3px;
                        }
                        
                        td {
                            padding: 4px 3px;
                            border-bottom: 1px solid #eee;
                            vertical-align: top;
                        }
                        
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        
                        .narrow {
                            width: 35px;
                            text-align: center;
                        }
                        
                        .text-right {
                            text-align: right;
                        }
                        
                        .totals {
                            display: flex;
                            justify-content: flex-end;
                            margin-top: 10px;
                            font-weight: 700;
                        }
                        
                        .totals div {
                            margin-left: 20px;
                        }
                        
                        .summary-heading {
                            font-size: 12px;
                            font-weight: 700;
                            margin: 15px 0 5px 0;
                            color: var(--primary-color);
                            border-bottom: 1px solid var(--border-color);
                            padding-bottom: 3px;
                        }
                        
                        .summary-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 10px;
                        }
                        
                        .summary-item {
                            background-color: #f5f5f5;
                            padding: 4px 8px;
                            border-radius: 4px;
                            white-space: nowrap;
                            font-size: 11px;
                        }
                        
                        .footer {
                            margin-top: 20px;
                            font-size: 10px;
                            color: #666;
                            text-align: center;
                        }
                        
                        .print-buttons {
                            text-align: center;
                            margin-top: 20px;
                        }
                        
                        button {
                            padding: 8px 15px;
                            background-color: var(--primary-color);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                        
                        @media print {
                            .print-buttons {
                                display: none;
                            }
                            
                            body {
                                padding: 0;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            
                            @page {
                                margin: 0.5cm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="compact-header">
                        <div class="logo-container">
                                ${companyLogo ? `<img src="${companyLogo}" alt="Logo" class="logo">` : ''}
                        </div>
                        <div class="company-info">
                            <h1>${companyName}</h1>
                                <p>${companyAddress}</p>
                                <p>Tel: ${companyPhone} | Email: ${companyEmail}</p>
                                <p>CNPJ: ${companyCNPJ}</p>
                            </div>
                            <div class="document-details">
                                <h2>OR√áAMENTO</h2>
                                <p><strong>N¬∫:</strong> ${quoteNumber}</p>
                                <p><strong>Data:</strong> ${formattedDate}</p>
                                <p><strong>Validade:</strong> 15 dias</p>
                        </div>
                    </div>
                    
                        <div class="client-section">
                            <div class="client-info">
                                <div class="subtitle">CLIENTE</div>
                                <p><strong>Nome:</strong> ${clientName}</p>
                                ${clientContact ? `<p><strong>Contato:</strong> ${clientContact}</p>` : ''}
                            </div>
                            <div class="quote-info">
                                <div class="subtitle">CONDI√á√ïES</div>
                                <p><strong>Pagamento:</strong> 50% entrada, 50% na entrega</p>
                                <p><strong>Entrega:</strong> 5-7 dias ap√≥s confirma√ß√£o</p>
                            </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                    <th class="narrow">N¬∫</th>
                                <th>Dimens√µes</th>
                                    <th>Qtd</th>
                                    <th>Volume</th>
                                    <th class="text-right">Unit.</th>
                                    <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                                ${Array.from(items).map((item, index) => {
                                    // Obter dados do item
                                    const sizeText = item.children[0].textContent;
                                    const packageQuantity = item.dataset.packageQuantity || 1;
                                    const quantity = item.dataset.quantity || item.children[1].textContent;
                                    const totalQuantity = item.dataset.totalQuantity || quantity;
                                    const volume = item.children[2].textContent;
                                    const priceText = item.children[3].textContent;
                                    
                                    // Calcular pre√ßo unit√°rio
                                    const totalPrice = parseFloat(priceText.replace(/[^0-9,.]/g, '').replace('.', '').replace(',', '.'));
                                    const volumeValue = parseFloat(volume.replace(/[^0-9,.]/g, '').replace(',', '.'));
                                    const unitPrice = volumeValue ? totalPrice / volumeValue : 0;
                                    
                                    // Determinar formato de exibi√ß√£o para quantidade
                                    let quantityDisplay = quantity;
                                    if (parseInt(packageQuantity) > 1) {
                                        quantityDisplay = `${quantity}√ó${packageQuantity}`;
                                    }
                                    
                                    return `
                                    <tr>
                                        <td class="narrow">${index + 1}</td>
                                        <td>${sizeText}</td>
                                        <td>${quantityDisplay}</td>
                                        <td>${volume}</td>
                                        <td class="text-right">R$ ${unitPrice.toFixed(2).replace('.', ',')}</td>
                                        <td class="text-right">${priceText}</td>
                                </tr>
                                    `;
                                }).join('')}
                        </tbody>
                    </table>

                    <div class="totals">
                            ${(() => {
                                const totalRow = document.querySelector('.total-row');
                                if (totalRow) {
                                    const totalPieces = totalRow.children[1].textContent;
                                    const totalVolume = totalRow.children[2].textContent;
                                    const totalPrice = totalRow.children[3].textContent;
                                    
                                    return `
                                    <div>Pe√ßas: ${totalPieces}</div>
                                    <div>Volume: ${totalVolume}</div>
                                    <div>Total: ${totalPrice}</div>
                                    `;
                                }
                                return '';
                            })()}
                        </div>
                        
                        <div class="summary-heading">Resumo por dimens√µes</div>
                        <div class="summary-container">
                            ${(() => {
                                // Criar resumo agrupado por esp√©cies (primeiro) e dimens√µes (segundo)
                                const speciesMap = new Map();
                                
                                Array.from(items).forEach(item => {
                                    // Obter a dimens√£o e formatar com X mai√∫sculo
                                    let size = item.children[0].textContent;
                                    // Se ainda estiver no formato antigo com 'x' min√∫sculo, converter
                                    if (size.includes('x')) {
                                        const parts = size.split('x');
                                        size = parts.join(' X ');
                                    }
                                    
                                    const totalQuantity = item.dataset.totalQuantity || item.children[1].textContent;
                                    const volume = item.children[2].textContent;
                                    
                                    // Obter a esp√©cie, se n√£o tiver usar "Sem Esp√©cie"
                                    const species = item.dataset.species || "Sem Esp√©cie";
                                    
                                    // Se a esp√©cie n√£o existe no mapa, criar
                                    if (!speciesMap.has(species)) {
                                        speciesMap.set(species, new Map());
                                    }
                                    
                                    // Obter o mapa de dimens√µes para esta esp√©cie
                                    const dimensionMap = speciesMap.get(species);
                                    
                                    // Adicionar ou atualizar informa√ß√µes da dimens√£o
                                    if (dimensionMap.has(size)) {
                                        const existing = dimensionMap.get(size);
                                        existing.quantity += parseInt(totalQuantity);
                                        existing.volume += parseFloat(volume.replace(/[^0-9,.]/g, '').replace(',', '.'));
                                    } else {
                                        dimensionMap.set(size, {
                                            quantity: parseInt(totalQuantity),
                                            volume: parseFloat(volume.replace(/[^0-9,.]/g, '').replace(',', '.'))
                                        });
                                    }
                                });
                                
                                // Adicionar estilos para o layout em colunas
                                let summaryHTML = `
                                <style>
                                    .species-cards {
                                        display: flex;
                                        flex-wrap: wrap;
                                        gap: 20px;
                                        margin-bottom: 20px;
                                    }
                                    
                                    .species-card {
                                        flex: 1;
                                        min-width: 300px;
                                        background-color: #f9f9f9;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                                        border: 1px solid #eaeaea;
                                    }
                                    
                                    .species-title {
                                        font-weight: bold;
                                        color: var(--primary-color);
                                        padding-bottom: 5px;
                                        margin-bottom: 10px;
                                        border-bottom: 1px solid #ddd;
                                    }
                                    
                                    .dimension-table {
                                        width: 100%;
                                        border-collapse: collapse;
                                    }
                                    
                                    .dimension-table td {
                                        padding: 2px 0;
                                        border: none;
                                    }
                                    
                                    .dimension-col-1 {
                                        width: 50%;
                                        text-align: left;
                                    }
                                    
                                    .dimension-col-2 {
                                        width: 25%;
                                        text-align: right;
                                    }
                                    
                                    .dimension-col-3 {
                                        width: 25%;
                                        text-align: right;
                                    }
                                    
                                    .species-total {
                                        margin-top: 10px;
                                        padding-top: 5px;
                                        border-top: 1px solid #ddd;
                                        font-weight: bold;
                                        text-align: right;
                                    }
                                </style>
                                <div class="species-cards">`;
                                
                                // Para cada esp√©cie, criar um card
                                speciesMap.forEach((dimensionMap, species) => {
                                    summaryHTML += `
                                    <div class="species-card">
                                        <div class="species-title">Resumo: ${species}</div>
                                        <table class="dimension-table">`;
                                        
                                        // Somar o volume total da esp√©cie
                                        let speciesVolume = 0;
                                        
                                        // Para cada dimens√£o desta esp√©cie
                                        dimensionMap.forEach((data, size) => {
                                            speciesVolume += data.volume;
                                            summaryHTML += `
                                            <tr>
                                                <td class="dimension-col-1">${size}</td>
                                                <td class="dimension-col-2">${data.quantity} PE√áAS</td>
                                                <td class="dimension-col-3">${data.volume.toFixed(3).replace('.', ',')}m¬≥</td>
                                            </tr>`;
                                        });
                                        
                                        // Adicionar linha do total
                                        summaryHTML += `
                                            <tr>
                                                <td colspan="3" class="species-total">TOTAL: ${speciesVolume.toFixed(3).replace('.', ',')}m¬≥</td>
                                            </tr>
                                        </table>
                                    </div>`;
                                });
                                
                                summaryHTML += `</div>`;
                                return summaryHTML;
                            })()}
                    </div>

                    <div class="footer">
                            <p>Agradecemos sua prefer√™ncia! Para mais informa√ß√µes: ${companyPhone}</p>
                            <p>Este documento n√£o possui valor fiscal - Gerado em ${new Date().toLocaleString()}</p>
                    </div>

                        <div class="print-buttons">
                            <button onclick="window.print()">Imprimir Or√ßamento</button>
                            <button onclick="window.close()" style="margin-left: 10px; background-color: #333;">Fechar</button>
                        </div>
                    </div>
                </body>
                </html>
            `;

            reportWindow.document.write(reportContent);
            reportWindow.document.close();
        }

        // Fun√ß√£o para atualizar a label do campo quantidade
        function updateQuantityLabel() {
            const packageQuantity = parseInt(document.getElementById('packageQuantity').value) || 1;
            const quantityUnitLabel = document.getElementById('quantityUnit');
            
            if (packageQuantity > 1) {
                quantityUnitLabel.textContent = 'Pacotes';
            } else {
                quantityUnitLabel.textContent = 'Pe√ßas';
            }
        }

        // Fun√ß√£o para salvar como or√ßamento
        function saveAsQuote() {
            try {
                console.log("Iniciando salvamento de or√ßamento");
                
                // Verificar se h√° itens na lista
                const itemsList = document.getElementById('itemsList');
                if (!itemsList || itemsList.children.length === 0) {
                    showFeedback("Adicione pelo menos um item para salvar como or√ßamento", "error");
                    return;
                }

                // Extrair a lista de itens
                let items = [];
                for (let i = 0; i < itemsList.children.length; i++) {
                    const item = itemsList.children[i];
                    // Ignorar a linha de total
                    if (item.classList.contains('total-row')) continue;
                    
                    // Obter tamanho (que cont√©m largura, espessura e comprimento)
                    const sizeText = item.children[0].textContent.trim();
                    
                    // Obter quantidade
                    const quantityText = item.children[1].textContent.trim();
                    
                    // Obter volume
                    const volumeText = item.children[2].textContent.trim();
                    
                    // Obter pre√ßo
                    const priceText = item.children[3].textContent.trim();
                    
                    // Obter valores dos atributos data-* 
                    const species = item.dataset.species || '';
                    const packageQuantity = parseInt(item.dataset.packageQuantity || '1');
                    const quantity = parseInt(item.dataset.quantity || '1');
                    
                    // Calcular o volume e pre√ßo como n√∫meros
                    const totalVolume = parseFloat(volumeText.replace(/[^0-9,.]/g, '').replace(',', '.'));
                    const finalPrice = parseFloat(priceText.replace(/[^0-9,.]/g, '').replace('.', '').replace(',', '.'));

                    // Obter dimens√µes do tamanho (formato: "thickness X width X length")
                    let thickness = 0, width = 0, length = 0;
                    const sizeParts = sizeText.split('X').map(part => part.trim());
                    if (sizeParts.length === 3) {
                        thickness = parseFloat(sizeParts[0].replace(',', '.'));
                        width = parseFloat(sizeParts[1].replace(',', '.'));
                        length = parseFloat(sizeParts[2].replace(',', '.'));
                    }
                    
                    items.push({
                        size: sizeText,
                        width: width,
                        thickness: thickness,
                        length: length,
                        quantity: quantity,
                        packageQuantity: packageQuantity,
                        species: species,
                        volume: volumeText,
                        price: priceText,
                        totalVolume: totalVolume,
                        finalPrice: finalPrice
                    });
                }

                console.log("Items processados:", items);

                // Obter o volume total e pre√ßo total
                const totalRow = document.querySelector('.total-row');
                if (!totalRow) {
                    console.error("Linha de total n√£o encontrada");
                    calcularTotal(); // Tentar recalcular o total
                    showFeedback("Erro ao calcular o pre√ßo total. Tente novamente.", "error");
                    return;
                }
                
                const totalVolume = parseFloat(totalRow.children[2].textContent.replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
                const totalPrice = parseFloat(totalRow.children[3].textContent.replace(/[^0-9,.]/g, '').replace('.', '').replace(',', '.')) || 0;
                
                console.log("Volume total:", totalVolume, "Pre√ßo total:", totalPrice);

                // Obter informa√ß√µes do cliente
                const clientName = document.getElementById('clientName').value.trim();
                const clientContact = document.getElementById('clientContact').value.trim();
                const species = document.getElementById('species').value.trim();
                
                // Verificar se o cliente foi preenchido
                if (!clientName) {
                    showFeedback("Preencha o nome do cliente para salvar como or√ßamento", "error");
                    return;
                }

                // Obter a data atual formatada
                const currentDate = new Date();
                const formattedDate = `${currentDate.getDate().toString().padStart(2, '0')}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getFullYear()} ${currentDate.getHours().toString().padStart(2, '0')}:${currentDate.getMinutes().toString().padStart(2, '0')}`;

                // Garantir que temos um ID de usu√°rio
                let userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    userId = 'user_' + Date.now();
                    localStorage.setItem('currentUserId', userId);
                    console.log("ID de usu√°rio criado:", userId);
                }

                // Preparar objeto de or√ßamento
                const quote = {
                    id: editingQuoteId || `quote_${Date.now()}`,
                    clientName: clientName,
                    clientContact: clientContact,
                    species: species,
                    date: formattedDate,
                    items: items,
                    totalVolume: totalVolume,
                    totalPrice: totalPrice
                };

                console.log("Or√ßamento preparado:", quote);

                // Salvar o or√ßamento
                saveQuote(quote);
                
                // NOVO: Limpar a lista ap√≥s salvar o or√ßamento
                clearList();
                
                // Adicionar um atraso antes do redirecionamento para garantir que o localStorage foi atualizado
                console.log("Or√ßamento salvo. Redirecionando para a p√°gina de or√ßamentos...");
                
                // Usar setTimeout para dar tempo ao localStorage ser atualizado
                setTimeout(function() {
                    window.location.href = 'orcamentos.html';
                }, 500);
            } catch (error) {
                console.error("Erro ao salvar or√ßamento:", error);
                showFeedback("Erro ao salvar o or√ßamento: " + error.message, "error");
            }
        }

        function saveQuote(quote) {
            try {
                // Buscar or√ßamentos existentes
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error("ID do usu√°rio n√£o encontrado");
                }
                
                console.log("Salvando or√ßamento para usu√°rio:", userId);
                let userQuotes = JSON.parse(localStorage.getItem(`quotes_${userId}`) || '[]');
                
                // Verificar se √© um or√ßamento existente para edi√ß√£o
                if (editingQuoteId) {
                    const existingIndex = userQuotes.findIndex(q => q.id === editingQuoteId);
                    if (existingIndex !== -1) {
                        // Atualizar o or√ßamento existente
                        userQuotes[existingIndex] = quote;
                        showFeedback("Or√ßamento atualizado com sucesso!", "success");
                    } else {
                        // Se n√£o encontrou, adicionar como novo
                        userQuotes.push(quote);
                        showFeedback("Or√ßamento salvo com sucesso!", "success");
                    }
                } else {
                    // Adicionar novo or√ßamento
                    userQuotes.push(quote);
                    
                    // Atualizar estat√≠sticas do usu√°rio
                    try {
                        updateUserStats('quotes');
                    } catch (e) {
                        console.warn("Erro ao atualizar estat√≠sticas:", e);
                    }
                    
                    showFeedback("Or√ßamento salvo com sucesso!", "success");
                }
                
                // Salvar os or√ßamentos atualizados
                localStorage.setItem(`quotes_${userId}`, JSON.stringify(userQuotes));
                console.log("Or√ßamentos salvos com sucesso. Total:", userQuotes.length);
            } catch (error) {
                console.error("Erro ao salvar or√ßamento:", error);
                showFeedback("Erro ao salvar: " + error.message, "error");
                throw error; // Propagar o erro para tratamento adicional
            }
        }

        // Verificar se estamos carregando um or√ßamento para edi√ß√£o
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('edit')) {
            console.log("Carregando or√ßamento para edi√ß√£o");
            loadQuoteForEditing(urlParams.get('edit'));
        }

        // Corrigir a formata√ß√£o de pre√ßo e garantir c√°lculo imediato
        function initializeCurrencyInput() {
            const priceInput = document.getElementById('price');
            if (!priceInput) return;
            
            // Definir valor inicial
            if (!priceInput.value || priceInput.value === '') {
                priceInput.value = 'R$ 0,00';
            }
            
            // Limpar eventos existentes
            const newPriceInput = priceInput.cloneNode(true);
            priceInput.parentNode.replaceChild(newPriceInput, priceInput);
            
            // Adicionar novo evento
            newPriceInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = (parseInt(value, 10) / 100).toFixed(2);
                value = value.replace('.', ',');
                e.target.value = `R$ ${value}`;
                
                // Chamar calculate imediatamente ap√≥s atualizar o valor
                calculate();
            });
            
            // Adicionar eventos de foco
            newPriceInput.addEventListener('focus', function(e) {
                // Posicionar cursor no final
                const val = e.target.value;
                e.target.value = '';
                e.target.value = val;
                
                // Selecionar todo o texto ao focar
                setTimeout(() => {
                    e.target.select();
                }, 10);
            });
        }

        // Adicionar um evento para executar o c√°lculo quando a p√°gina estiver totalmente carregada
        window.addEventListener('load', function() {
            console.log("P√°gina completamente carregada. For√ßando c√°lculo...");
            calculate();
        });

        // NOVA fun√ß√£o para limpar a lista
        function clearList() {
            try {
                // Limpar o conte√∫do da lista no DOM
                const itemsList = document.getElementById('itemsList');
                if (itemsList) {
                    itemsList.innerHTML = '';
                }
                
                // Limpar a lista salva no localStorage
                localStorage.removeItem('woodList');
                
                // Atualizar os totais para refletir a lista vazia
                calcularTotal();
                
                // Mostrar feedback
                showFeedback("Lista limpa com sucesso!", "success");
                
                console.log("Lista limpa ap√≥s salvar or√ßamento");
            } catch (error) {
                console.error("Erro ao limpar lista:", error);
            }
        }

        // Adicionar uma fun√ß√£o dedicada para inicializar o autocomplete logo ap√≥s a declara√ß√£o do DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("DOMContentLoaded iniciado");
                
                // Garantir que o autocomplete seja inicializado primeiro, antes de qualquer outra coisa
                setTimeout(() => {
                    console.log("Inicializando autocomplete ap√≥s delay...");
                    initAutocomplete();
                }, 100); // Pequeno delay para garantir que os elementos estejam completamente carregados
                
                // Resto do c√≥digo existente
                // ... existing code ...
            } catch (error) {
                console.error("Erro durante o carregamento da p√°gina:", error);
            }
        });

        // Nova fun√ß√£o espec√≠fica para inicializar o autocomplete de forma robusta
        function initAutocomplete() {
            console.log("Inicializando autocomplete...");
            
            try {
                // Inicializar lista de clientes se n√£o existir
                if (!localStorage.getItem('clients')) {
                    localStorage.setItem('clients', JSON.stringify([]));
                    console.log("Lista de clientes inicializada com array vazio");
                }
                
                // Inicializar lista de esp√©cies se n√£o existir
                if (!localStorage.getItem('species')) {
                    const especiesIniciais = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                    localStorage.setItem('species', JSON.stringify(especiesIniciais));
                    console.log("Lista de esp√©cies inicializada com valores padr√£o:", especiesIniciais);
                } else {
                    // Verificar se h√° algum problema com o localStorage
                    try {
                        const testSpecies = JSON.parse(localStorage.getItem('species'));
                        console.log("Esp√©cies existentes:", testSpecies);
                        
                        // Se a lista estiver vazia, preench√™-la com valores padr√£o
                        if (!testSpecies || testSpecies.length === 0) {
                            const especiesIniciais = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                            localStorage.setItem('species', JSON.stringify(especiesIniciais));
                            console.log("Lista de esp√©cies estava vazia, inicializada com valores padr√£o:", especiesIniciais);
                        }
                    } catch (e) {
                        // Reset da lista se houver erro no parsing
                        console.error("Erro ao ler esp√©cies do localStorage:", e);
                        const especiesIniciais = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                        localStorage.setItem('species', JSON.stringify(especiesIniciais));
                        console.log("Lista de esp√©cies resetada com valores padr√£o ap√≥s erro:", especiesIniciais);
                    }
                }
                
                // CLIENTE: Configurar autocomplete com valida√ß√£o de elementos
                const clientInput = document.getElementById('clientName');
                const clientAutocomplete = document.getElementById('clientAutocomplete');
                
                if (!clientInput) {
                    console.error("Elemento de input do cliente n√£o encontrado!");
                    return;
                }
                
                if (!clientAutocomplete) {
                    console.error("Elemento de autocomplete do cliente n√£o encontrado!");
                    // Tentar criar o elemento se ele n√£o existir
                    if (clientInput.parentNode) {
                        const newAutocomplete = document.createElement('div');
                        newAutocomplete.id = 'clientAutocomplete';
                        newAutocomplete.className = 'autocomplete-items';
                        clientInput.parentNode.appendChild(newAutocomplete);
                        console.log("Criado elemento de autocomplete para cliente");
                    }
                    return;
                }
                
                // Remover eventos existentes para evitar duplica√ß√£o clonando o elemento
                const newClientInput = clientInput.cloneNode(true);
                clientInput.parentNode.replaceChild(newClientInput, clientInput);
                
                // Adicionar evento de foco para mostrar todas as op√ß√µes quando o campo est√° vazio
                newClientInput.addEventListener('focus', function() {
                    if (!this.value.trim()) {
                        const allClients = JSON.parse(localStorage.getItem('clients')) || [];
                        
                        // Limpar sugest√µes anteriores
                        clientAutocomplete.innerHTML = '';
                        
                        // Mostrar at√© 10 sugest√µes
                        allClients.slice(0, 10).forEach(client => {
                            const item = document.createElement('div');
                            item.textContent = client;
                            item.addEventListener('click', function() {
                                newClientInput.value = client;
                                clientAutocomplete.innerHTML = '';
                                clientAutocomplete.style.display = 'none';
                            });
                            clientAutocomplete.appendChild(item);
                        });
                        
                        // Mostrar o container de autocompletar somente se houver sugest√µes
                        if (allClients.length > 0) {
                            clientAutocomplete.style.display = 'block';
                        }
                    }
                });
                
                // Evento de input para filtrar as sugest√µes conforme o usu√°rio digita
                newClientInput.addEventListener('input', function() {
                    const term = this.value.trim().toLowerCase();
                    let clients = [];
                    
                    try {
                        clients = JSON.parse(localStorage.getItem('clients')) || [];
                    } catch (e) {
                        console.error("Erro ao carregar clientes:", e);
                        clients = [];
                    }
                    
                    console.log("Pesquisando clientes com termo:", term);
                    
                    // Limpar sugest√µes anteriores
                    clientAutocomplete.innerHTML = '';
                    
                    // Filtrar clientes que correspondem ao termo
                    const matchingClients = clients.filter(client => 
                        client && client.toLowerCase().includes(term)
                    );
                    
                    console.log("Clientes correspondentes:", matchingClients);
                    
                    // Mostrar at√© 5 sugest√µes
                    matchingClients.slice(0, 5).forEach(client => {
                        const item = document.createElement('div');
                        item.textContent = client;
                        item.addEventListener('click', function() {
                            newClientInput.value = client;
                            clientAutocomplete.innerHTML = '';
                            clientAutocomplete.style.display = 'none';
                        });
                        clientAutocomplete.appendChild(item);
                    });
                    
                    // Mostrar o container de autocompletar
                    if (matchingClients.length > 0) {
                        clientAutocomplete.style.display = 'block';
                    } else {
                        clientAutocomplete.style.display = 'none';
                    }
                });
                
                // ESP√âCIE: Configurar autocomplete com valida√ß√£o de elementos
                const speciesInput = document.getElementById('species');
                const speciesAutocomplete = document.getElementById('speciesAutocomplete');
                
                if (!speciesInput) {
                    console.error("Elemento de input de esp√©cie n√£o encontrado!");
                    return;
                }
                
                if (!speciesAutocomplete) {
                    console.error("Elemento de autocomplete de esp√©cie n√£o encontrado!");
                    // Tentar criar o elemento se ele n√£o existir
                    if (speciesInput.parentNode) {
                        const newAutocomplete = document.createElement('div');
                        newAutocomplete.id = 'speciesAutocomplete';
                        newAutocomplete.className = 'autocomplete-items';
                        speciesInput.parentNode.appendChild(newAutocomplete);
                        console.log("Criado elemento de autocomplete para esp√©cie");
                    }
                    return;
                }
                
                // Remover eventos existentes para evitar duplica√ß√£o clonando o elemento
                const newSpeciesInput = speciesInput.cloneNode(true);
                speciesInput.parentNode.replaceChild(newSpeciesInput, speciesInput);
                
                // Adicionar evento de foco para mostrar todas as op√ß√µes quando o campo est√° vazio
                newSpeciesInput.addEventListener('focus', function() {
                    // Se o campo estiver vazio ao focar, mostrar todas as op√ß√µes
                    if (!this.value.trim()) {
                        let allSpecies = [];
                        
                        try {
                            allSpecies = JSON.parse(localStorage.getItem('species')) || [];
                            
                            // Se a lista estiver vazia, usar valores padr√£o
                            if (allSpecies.length === 0) {
                                allSpecies = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                                localStorage.setItem('species', JSON.stringify(allSpecies));
                            }
                        } catch (e) {
                            console.error("Erro ao carregar esp√©cies:", e);
                            allSpecies = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                            localStorage.setItem('species', JSON.stringify(allSpecies));
                        }
                        
                        // Limpar sugest√µes anteriores
                        speciesAutocomplete.innerHTML = '';
                        
                        // Mostrar at√© 10 sugest√µes
                        allSpecies.slice(0, 10).forEach(species => {
                            const item = document.createElement('div');
                            item.textContent = species;
                            item.addEventListener('click', function() {
                                newSpeciesInput.value = species;
                                speciesAutocomplete.innerHTML = '';
                                speciesAutocomplete.style.display = 'none';
                            });
                            speciesAutocomplete.appendChild(item);
                        });
                        
                        // Mostrar o container de autocompletar
                        if (allSpecies.length > 0) {
                            speciesAutocomplete.style.display = 'block';
                        }
                    }
                });
                
                // Evento de input para filtrar as sugest√µes conforme o usu√°rio digita
                newSpeciesInput.addEventListener('input', function() {
                    const term = this.value.trim().toLowerCase();
                    let speciesList = [];
                    
                    try {
                        speciesList = JSON.parse(localStorage.getItem('species')) || [];
                        
                        // Se a lista estiver vazia, usar valores padr√£o
                        if (speciesList.length === 0) {
                            speciesList = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                            localStorage.setItem('species', JSON.stringify(speciesList));
                        }
                    } catch (e) {
                        console.error("Erro ao carregar esp√©cies:", e);
                        speciesList = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                        localStorage.setItem('species', JSON.stringify(speciesList));
                    }
                    
                    console.log("Pesquisando esp√©cies com termo:", term);
                    console.log("Esp√©cies dispon√≠veis:", speciesList);
                    
                    // Limpar sugest√µes anteriores
                    speciesAutocomplete.innerHTML = '';
                    
                    // Filtrar esp√©cies que correspondem ao termo
                    const matchingSpecies = speciesList.filter(species => 
                        species && species.toLowerCase().includes(term)
                    );
                    
                    console.log("Esp√©cies correspondentes:", matchingSpecies);
                    
                    // Mostrar at√© 5 sugest√µes
                    matchingSpecies.slice(0, 5).forEach(species => {
                        const item = document.createElement('div');
                        item.textContent = species;
                        item.addEventListener('click', function() {
                            newSpeciesInput.value = species;
                            speciesAutocomplete.innerHTML = '';
                            speciesAutocomplete.style.display = 'none';
                        });
                        speciesAutocomplete.appendChild(item);
                    });
                    
                    // Mostrar o container de autocompletar
                    if (matchingSpecies.length > 0) {
                        speciesAutocomplete.style.display = 'block';
                    } else {
                        speciesAutocomplete.style.display = 'none';
                    }
                });
                
                // Salvar cliente e esp√©cie quando perder o foco
                newClientInput.addEventListener('blur', function() {
                    const clientName = this.value.trim();
                    if (clientName) {
                        saveClientToLocalStorage(clientName);
                    }
                    // Ocultar sugest√µes ap√≥s um pequeno atraso (para permitir o clique)
                    setTimeout(() => {
                        clientAutocomplete.style.display = 'none';
                    }, 200);
                });
                
                newSpeciesInput.addEventListener('blur', function() {
                    const speciesName = this.value.trim();
                    if (speciesName) {
                        saveSpeciesToLocalStorage(speciesName);
                    }
                    // Ocultar sugest√µes ap√≥s um pequeno atraso (para permitir o clique)
                    setTimeout(() => {
                        speciesAutocomplete.style.display = 'none';
                    }, 200);
                });
                
                console.log("Autocomplete inicializado com sucesso");
            } catch (error) {
                console.error("Erro ao inicializar autocomplete:", error);
                
                // Tenta inicializar novamente ap√≥s um breve intervalo para dar tempo aos elementos serem carregados
                setTimeout(() => {
                    console.log("Tentando inicializar autocomplete novamente...");
                    try {
                        // C√≥digo simplificado para uma segunda tentativa
                        const especiesIniciais = ["Peroba", "Pinus", "Cedro", "Ip√™", "Timborana", "Ma√ßaranduba"];
                        localStorage.setItem('species', JSON.stringify(especiesIniciais));
                        
                        // Eventos b√°sicos para os inputs se existirem
                        const speciesInput = document.getElementById('species');
                        const clientInput = document.getElementById('clientName');
                        
                        if (speciesInput) {
                            speciesInput.addEventListener('focus', function() {
                                alert("Lista de esp√©cies dispon√≠veis: " + especiesIniciais.join(", "));
                            });
                        }
                        
                        console.log("Segunda tentativa de inicializa√ß√£o conclu√≠da");
                    } catch (retryError) {
                        console.error("Falha na segunda tentativa de inicializar autocomplete:", retryError);
                    }
                }, 500);
            }
        }

        // Fun√ß√£o para salvar cliente no localStorage com melhor tratamento de erros
        function saveClientToLocalStorage(clientName) {
            try {
                if (!clientName || clientName.trim() === '') {
                    console.log("Nome de cliente vazio, ignorando salvamento");
                    return;
                }
                
                const clients = JSON.parse(localStorage.getItem('clients')) || [];
                
                // Verifica se o cliente j√° existe (ignorando case)
                const clientExists = clients.some(client => 
                    client.toLowerCase() === clientName.toLowerCase()
                );
                
                if (!clientExists) {
                    clients.push(clientName);
                    localStorage.setItem('clients', JSON.stringify(clients));
                    console.log("Cliente salvo:", clientName);
                } else {
                    console.log("Cliente j√° existe, n√£o salvo novamente:", clientName);
                }
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
            }
        }

        // Fun√ß√£o para salvar esp√©cie no localStorage com melhor tratamento de erros
        function saveSpeciesToLocalStorage(speciesName) {
            try {
                if (!speciesName || speciesName.trim() === '') {
                    console.log("Nome de esp√©cie vazio, ignorando salvamento");
                    return;
                }
                
                const speciesList = JSON.parse(localStorage.getItem('species')) || [];
                
                // Verifica se a esp√©cie j√° existe (ignorando case)
                const speciesExists = speciesList.some(species => 
                    species.toLowerCase() === speciesName.toLowerCase()
                );
                
                if (!speciesExists) {
                    speciesList.push(speciesName);
                    localStorage.setItem('species', JSON.stringify(speciesList));
                    console.log("Esp√©cie salva:", speciesName);
                } else {
                    console.log("Esp√©cie j√° existe, n√£o salva novamente:", speciesName);
                }
            } catch (error) {
                console.error("Erro ao salvar esp√©cie:", error);
            }
        }
    </script>
</body>
</html> 