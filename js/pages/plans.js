/**
 * Plans Page Module - Calculadora de Madeira
 * M√≥dulo respons√°vel pela p√°gina de planos e assinaturas
 * Integrado com a arquitetura modular
 */

// Estado das assinaturas
let currentPlan = 'Gratuito';
let pendingRequest = false;
let selectedPlanForPayment = null;

// Aguardar inicializa√ß√£o da aplica√ß√£o principal
document.addEventListener('calculadoraMadeiraReady', (event) => {
    console.log('üí≥ Inicializando m√≥dulo de planos...');
    
    const app = event.detail.app;
    initializePlansPage(app);
});

/**
 * Inicializar p√°gina de planos
 */
function initializePlansPage(app) {
    console.log('üìã Configurando p√°gina de planos...');
    
    // Verificar autentica√ß√£o (flex√≠vel para visitantes)
    checkAuthentication();
    
    // Carregar dados do usu√°rio
    loadUserData();
    
    // Atualizar interface dos planos
    updatePlanUI();
    
    // Configurar eventos
    setupPlansEvents();
    
    console.log('‚úÖ P√°gina de planos inicializada');
}

/**
 * Verificar autentica√ß√£o (flex√≠vel)
 */
function checkAuthentication() {
    try {
        // Verificar se a fun√ß√£o isUserLoggedIn existe e execut√°-la
        if (typeof isUserLoggedIn === 'function' && !isUserLoggedIn()) {
            console.log('Usu√°rio n√£o autenticado, redirecionando...');
            window.location.href = 'index.html';
        } else if (typeof isUserLoggedIn !== 'function') {
            console.warn('Fun√ß√£o isUserLoggedIn n√£o encontrada. Criando ID de visitante tempor√°rio.');
            // Criar ID tempor√°rio para visitantes
            if (!localStorage.getItem('currentUserId')) {
                localStorage.setItem('currentUserId', 'visitor_' + Date.now());
            }
        }
    } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        // Em caso de erro, n√£o bloquear o acesso √† p√°gina
        // Apenas criar um ID tempor√°rio
        if (!localStorage.getItem('currentUserId')) {
            localStorage.setItem('currentUserId', 'visitor_' + Date.now());
        }
    }
}

/**
 * Carregar dados do usu√°rio
 */
function loadUserData() {
    // Obter ID do usu√°rio de v√°rias fontes poss√≠veis
    let userId = localStorage.getItem('currentUserId');
    
    // Se n√£o tiver userId, tentar obter da fun√ß√£o getCurrentUser
    if (!userId && typeof getCurrentUser === 'function') {
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.id) {
            userId = currentUser.id;
        }
    }
    
    // Se ainda n√£o tiver userId, criar um tempor√°rio (ser√° substitu√≠do no login)
    if (!userId) {
        console.log('Criando ID tempor√°rio para visitante');
        userId = 'visitor_' + Date.now();
        localStorage.setItem('currentUserId', userId);
    }
    
    // Obter dados do usu√°rio
    let user = {};
    try {
        user = JSON.parse(localStorage.getItem('user') || '{}');
        console.log('Dados do usu√°rio carregados:', user);
    } catch (error) {
        console.error('Erro ao carregar dados do usu√°rio:', error);
        user = {};
    }
    
    // Verificar se tem plano associado (tentar diferentes chaves)
    const planKeys = [
        `user_plan_${userId}`,
        'currentPlan',
        'userPlan'
    ];
    
    let planData = null;
    for (const key of planKeys) {
        try {
            const data = localStorage.getItem(key);
            if (data) {
                planData = JSON.parse(data);
                console.log(`Plano encontrado na chave ${key}:`, planData);
                break;
            }
        } catch (error) {
            console.error(`Erro ao carregar plano da chave ${key}:`, error);
        }
    }
    
    // Definir plano atual
    if (planData) {
        currentPlan = planData.name || planData.plan || 'Premium';
        
        // Verificar se tem request pendente
        if (planData.status === 'pending') {
            pendingRequest = true;
        }
    } else {
        currentPlan = 'Gratuito';
        pendingRequest = false;
    }
    
    console.log('Plano atual determinado:', currentPlan);
    console.log('Request pendente:', pendingRequest);
}

/**
 * Atualizar interface dos planos
 */
function updatePlanUI() {
    // Atualizar status do plano atual
    const currentPlanElement = document.getElementById('currentPlan');
    const planExpiryElement = document.getElementById('planExpiry');
    const pendingStatusElement = document.getElementById('pendingStatus');
    
    if (currentPlanElement) {
        currentPlanElement.textContent = currentPlan;
    }
    
    if (planExpiryElement) {
        if (currentPlan === 'Gratuito') {
            planExpiryElement.textContent = 'Sem data de expira√ß√£o';
        } else {
            // Verificar data de expira√ß√£o se existir
            const userId = localStorage.getItem('currentUserId');
            const planData = JSON.parse(localStorage.getItem(`user_plan_${userId}`) || '{}');
            if (planData.expiryDate) {
                const expiryDate = new Date(planData.expiryDate);
                planExpiryElement.textContent = `V√°lido at√©: ${expiryDate.toLocaleDateString('pt-BR')}`;
            } else {
                planExpiryElement.textContent = 'Sem data de expira√ß√£o definida';
            }
        }
    }
    
    // Mostrar/ocultar status pendente
    if (pendingStatusElement) {
        pendingStatusElement.style.display = pendingRequest ? 'block' : 'none';
    }
    
    // Atualizar bot√µes dos planos
    updatePlanButtons();
}

/**
 * Atualizar bot√µes dos planos
 */
function updatePlanButtons() {
    const freeButton = document.getElementById('freeButton');
    const basicButton = document.getElementById('basicButton');
    const premiumButton = document.getElementById('premiumButton');
    
    // Reset todos os bot√µes
    [freeButton, basicButton, premiumButton].forEach(button => {
        if (button) {
            button.classList.remove('primary', 'secondary');
            button.classList.add('secondary');
            button.textContent = 'Selecionar Plano';
            button.disabled = false;
        }
    });
    
    // Marcar plano atual
    if (currentPlan === 'Gratuito' && freeButton) {
        freeButton.textContent = 'Plano Atual';
        freeButton.disabled = true;
    } else if (currentPlan === 'B√°sico' && basicButton) {
        basicButton.textContent = 'Plano Atual';
        basicButton.disabled = true;
    } else if (currentPlan === 'Premium' && premiumButton) {
        premiumButton.textContent = 'Plano Atual';
        premiumButton.disabled = true;
    }
    
    // Desabilitar bot√µes se tiver request pendente
    if (pendingRequest) {
        [basicButton, premiumButton].forEach(button => {
            if (button && !button.disabled) {
                button.textContent = 'Solicita√ß√£o Pendente';
                button.disabled = true;
            }
        });
    }
}

/**
 * Configurar eventos da p√°gina
 */
function setupPlansEvents() {
    // Bot√µes de sele√ß√£o de plano
    const basicButton = document.getElementById('basicButton');
    const premiumButton = document.getElementById('premiumButton');
    
    if (basicButton) {
        basicButton.addEventListener('click', () => {
            if (!basicButton.disabled) {
                openPaymentModal('B√°sico', 'R$ 29,90');
            }
        });
    }
    
    if (premiumButton) {
        premiumButton.addEventListener('click', () => {
            if (!premiumButton.disabled) {
                openPaymentModal('Premium', 'R$ 59,90');
            }
        });
    }
    
    // Bot√£o de fechar modal
    const closeModalButton = document.querySelector('.payment-close');
    if (closeModalButton) {
        closeModalButton.addEventListener('click', closePaymentModal);
    }
    
    // Fechar modal clicando fora
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('click', (e) => {
            if (e.target === paymentModal) {
                closePaymentModal();
            }
        });
    }
    
    // Bot√£o de notificar pagamento
    const notifyPaymentButton = document.getElementById('notifyPayment');
    if (notifyPaymentButton) {
        notifyPaymentButton.addEventListener('click', notifyPayment);
    }
    
    // Link de admin (se existir)
    const adminLink = document.getElementById('adminLink');
    if (adminLink) {
        adminLink.addEventListener('click', (e) => {
            e.preventDefault();
            openAdminPanel();
        });
    }
    
    console.log('‚å®Ô∏è Eventos dos planos configurados');
}

/**
 * Abrir modal de pagamento
 */
function openPaymentModal(planName, planPrice) {
    selectedPlanForPayment = { name: planName, price: planPrice };
    
    // Atualizar conte√∫do do modal
    const paymentPlanElement = document.querySelector('.payment-plan');
    const paymentValueElement = document.querySelector('.payment-value');
    
    if (paymentPlanElement) {
        paymentPlanElement.textContent = `Plano ${planName}`;
    }
    
    if (paymentValueElement) {
        paymentValueElement.textContent = planPrice;
    }
    
    // Mostrar modal
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
    
    console.log('üí≥ Modal de pagamento aberto para:', planName);
}

/**
 * Fechar modal de pagamento
 */
function closePaymentModal() {
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scroll
    }
    
    selectedPlanForPayment = null;
    console.log('‚ùå Modal de pagamento fechado');
}

/**
 * Notificar pagamento realizado
 */
function notifyPayment() {
    if (!selectedPlanForPayment) {
        showFeedback('Erro: Plano n√£o selecionado', 'error');
        return;
    }
    
    try {
        const userId = localStorage.getItem('currentUserId');
        if (!userId) {
            showFeedback('Erro: Usu√°rio n√£o identificado', 'error');
            return;
        }
        
        // Salvar solicita√ß√£o pendente
        const requestData = {
            userId: userId,
            planName: selectedPlanForPayment.name,
            planPrice: selectedPlanForPayment.price,
            requestDate: new Date().toISOString(),
            status: 'pending',
            paymentNotified: true
        };
        
        // Salvar no localStorage (em um sistema real, seria enviado para servidor)
        localStorage.setItem(`user_plan_${userId}`, JSON.stringify(requestData));
        
        // Atualizar estado local
        pendingRequest = true;
        
        // Atualizar interface
        updatePlanUI();
        
        // Fechar modal
        closePaymentModal();
        
        // Mostrar feedback de sucesso
        showFeedback('Pagamento notificado! Sua solicita√ß√£o est√° sendo analisada pelo administrador.', 'success');
        
        console.log('‚úÖ Pagamento notificado:', requestData);
        
    } catch (error) {
        console.error('‚ùå Erro ao notificar pagamento:', error);
        showFeedback('Erro ao processar notifica√ß√£o. Tente novamente.', 'error');
    }
}

/**
 * Abrir painel administrativo
 */
function openAdminPanel() {
    // Verificar se √© admin (em um sistema real teria verifica√ß√£o mais robusta)
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.isAdmin || user.role === 'admin') {
        window.location.href = 'admin.html';
    } else {
        showFeedback('Acesso restrito a administradores', 'error');
    }
}

/**
 * Mostrar feedback ao usu√°rio
 */
function showFeedback(message, type = 'success') {
    // Remover feedback anterior se existir
    const existingFeedback = document.querySelector('.feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Criar novo feedback
    const feedback = document.createElement('div');
    feedback.className = `feedback ${type}`;
    feedback.textContent = message;
    
    // Adicionar ao DOM
    document.body.appendChild(feedback);
    
    // Remover automaticamente ap√≥s 4 segundos
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.remove();
        }
    }, 4000);
    
    console.log(`üì¢ Feedback (${type}):`, message);
}

// Disponibilizar fun√ß√µes globalmente para compatibilidade
window.PlansPageModule = {
    loadUserData,
    updatePlanUI,
    openPaymentModal,
    closePaymentModal,
    notifyPayment,
    openAdminPanel
};

// Verificar se DOM j√° carregou (fallback para compatibilidade)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üì¶ M√≥dulo de planos carregado (DOMContentLoaded)');
    });
} else {
    console.log('üì¶ M√≥dulo de planos carregado (DOM j√° pronto)');
} 