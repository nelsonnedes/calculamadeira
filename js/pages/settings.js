/**
 * Settings Page Module - Calculadora de Madeira
 * M√≥dulo respons√°vel pela p√°gina de configura√ß√µes
 * Integrado com a arquitetura modular
 */

// Aguardar inicializa√ß√£o da aplica√ß√£o principal
document.addEventListener('calculadoraMadeiraReady', (event) => {
    console.log('‚öôÔ∏è Inicializando m√≥dulo de configura√ß√µes...');
    
    const app = event.detail.app;
    initializeSettingsPage(app);
});

// Configura√ß√µes padr√£o do sistema
const DEFAULT_SETTINGS = {
    // Prefer√™ncias Gerais
    emailNotifications: true,
    darkMode: false,
    autoBackup: true,
    
    // Personaliza√ß√£o
    unitSystem: 'metric',
    numberFormat: 'pt-BR',
    
    // Notifica√ß√µes
    pushNotifications: true,
    backupReminders: true,
    
    // Backup e Sincroniza√ß√£o
    cloudSync: true,
    backupFrequency: 'daily',
    
    // Avan√ßadas
    debugMode: false,
    performanceMode: false,
    experimentalFeatures: false
};

// Estado atual das configura√ß√µes
let currentSettings = {};

/**
 * Inicializar p√°gina de configura√ß√µes
 */
function initializeSettingsPage(app) {
    console.log('üîß Configurando p√°gina de configura√ß√µes...');
    
    // Verificar autentica√ß√£o
    if (!checkUserAuthentication()) return;
    
    // Carregar configura√ß√µes
    loadSettings();
    
    // Configurar eventos
    setupSettingsEvents();
    
    // Aplicar configura√ß√µes visuais
    applyVisualSettings();
    
    // Carregar estat√≠sticas
    loadSettingsStats();
    
    console.log('‚úÖ P√°gina de configura√ß√µes inicializada');
}

/**
 * Verificar autentica√ß√£o do usu√°rio
 */
function checkUserAuthentication() {
    try {
        if (typeof isUserLoggedIn === 'function' && !isUserLoggedIn()) {
            console.log('üîí Usu√°rio n√£o autenticado, redirecionando...');
            window.location.href = 'index.html';
            return false;
        }
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao verificar autentica√ß√£o:', error);
        window.location.href = 'index.html';
        return false;
    }
}

/**
 * Carregar configura√ß√µes do localStorage
 */
function loadSettings() {
    try {
        const stored = localStorage.getItem('settings');
        
        if (stored) {
            currentSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
        } else {
            currentSettings = { ...DEFAULT_SETTINGS };
            saveSettings(); // Salvar configura√ß√µes padr√£o
        }
        
        // Aplicar configura√ß√µes na interface
        applySettingsToUI();
        
        console.log('üìã Configura√ß√µes carregadas:', currentSettings);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
        currentSettings = { ...DEFAULT_SETTINGS };
        showSettingsFeedback('Erro ao carregar configura√ß√µes, usando padr√µes', 'warning');
    }
}

/**
 * Aplicar configura√ß√µes na interface
 */
function applySettingsToUI() {
    // Prefer√™ncias Gerais
    setElementValue('emailNotifications', currentSettings.emailNotifications);
    setElementValue('darkMode', currentSettings.darkMode);
    setElementValue('autoBackup', currentSettings.autoBackup);
    
    // Personaliza√ß√£o
    setElementValue('unitSystem', currentSettings.unitSystem);
    setElementValue('numberFormat', currentSettings.numberFormat);
    
    // Notifica√ß√µes
    setElementValue('pushNotifications', currentSettings.pushNotifications);
    setElementValue('backupReminders', currentSettings.backupReminders);
    
    // Backup e Sincroniza√ß√£o
    setElementValue('cloudSync', currentSettings.cloudSync);
    setElementValue('backupFrequency', currentSettings.backupFrequency);
    
    // Configura√ß√µes avan√ßadas (se existirem)
    setElementValue('debugMode', currentSettings.debugMode);
    setElementValue('performanceMode', currentSettings.performanceMode);
    setElementValue('experimentalFeatures', currentSettings.experimentalFeatures);
}

/**
 * Definir valor de elemento da interface
 */
function setElementValue(id, value) {
    const element = document.getElementById(id);
    if (!element) return;
    
    if (element.type === 'checkbox') {
        element.checked = Boolean(value);
    } else {
        element.value = value;
    }
}

/**
 * Configurar eventos da p√°gina
 */
function setupSettingsEvents() {
    // Event listener para todos os controles de configura√ß√£o
    const settingsControls = document.querySelectorAll('.settings-list input, .settings-list select');
    
    settingsControls.forEach(control => {
        control.addEventListener('change', handleSettingChange);
    });
    
    // Bot√µes especiais
    setupSpecialButtons();
    
    console.log('‚å®Ô∏è Eventos de configura√ß√µes configurados');
}

/**
 * Configurar bot√µes especiais
 */
function setupSpecialButtons() {
    // Bot√£o de limpar dados
    const clearDataBtn = document.querySelector('[onclick="clearAllData()"]');
    if (clearDataBtn) {
        clearDataBtn.removeAttribute('onclick');
        clearDataBtn.addEventListener('click', clearAllData);
    }
    
    // Bot√£o de exportar configura√ß√µes
    const exportBtn = document.getElementById('exportSettings');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportSettings);
    }
    
    // Bot√£o de importar configura√ß√µes
    const importBtn = document.getElementById('importSettings');
    const importFile = document.getElementById('importFile');
    
    if (importBtn && importFile) {
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importSettings);
    }
    
    // Bot√£o de reset para padr√µes
    const resetBtn = document.getElementById('resetToDefaults');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetToDefaults);
    }
}

/**
 * Manipular mudan√ßa de configura√ß√£o
 */
function handleSettingChange(event) {
    const element = event.target;
    const settingKey = element.id;
    let value;
    
    // Obter valor baseado no tipo do elemento
    if (element.type === 'checkbox') {
        value = element.checked;
    } else {
        value = element.value;
    }
    
    // Atualizar configura√ß√£o
    currentSettings[settingKey] = value;
    
    // Salvar configura√ß√µes
    saveSettings();
    
    // Aplicar configura√ß√£o espec√≠fica
    applySpecificSetting(settingKey, value);
    
    console.log(`‚öôÔ∏è Configura√ß√£o alterada: ${settingKey} = ${value}`);
}

/**
 * Aplicar configura√ß√£o espec√≠fica
 */
function applySpecificSetting(key, value) {
    switch (key) {
        case 'darkMode':
            toggleDarkMode(value);
            break;
            
        case 'unitSystem':
            updateUnitSystem(value);
            break;
            
        case 'numberFormat':
            updateNumberFormat(value);
            break;
            
        case 'pushNotifications':
            handlePushNotifications(value);
            break;
            
        case 'debugMode':
            toggleDebugMode(value);
            break;
            
        case 'performanceMode':
            togglePerformanceMode(value);
            break;
    }
}

/**
 * Toggle modo escuro
 */
function toggleDarkMode(enabled) {
    if (enabled) {
        document.body.classList.add('theme-dark');
        showSettingsFeedback('Modo escuro ativado', 'success');
    } else {
        document.body.classList.remove('theme-dark');
        showSettingsFeedback('Modo claro ativado', 'success');
    }
}

/**
 * Atualizar sistema de unidades
 */
function updateUnitSystem(system) {
    // Aplicar sistema de unidades globalmente
    if (typeof window.updateUnitSystem === 'function') {
        window.updateUnitSystem(system);
    }
    
    const systemName = system === 'metric' ? 'M√©trico' : 'Imperial';
    showSettingsFeedback(`Sistema ${systemName} aplicado`, 'success');
}

/**
 * Atualizar formato de n√∫meros
 */
function updateNumberFormat(format) {
    // Aplicar formato de n√∫meros globalmente
    if (typeof window.updateNumberFormat === 'function') {
        window.updateNumberFormat(format);
    }
    
    const formatName = format === 'pt-BR' ? 'Brasileiro' : 'Americano';
    showSettingsFeedback(`Formato ${formatName} aplicado`, 'success');
}

/**
 * Gerenciar notifica√ß√µes push
 */
function handlePushNotifications(enabled) {
    if (enabled) {
        // Solicitar permiss√£o para notifica√ß√µes
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showSettingsFeedback('Notifica√ß√µes push ativadas', 'success');
                } else {
                    showSettingsFeedback('Permiss√£o para notifica√ß√µes negada', 'warning');
                    // Desativar o toggle se permiss√£o foi negada
                    currentSettings.pushNotifications = false;
                    setElementValue('pushNotifications', false);
                    saveSettings();
                }
            });
        } else {
            showSettingsFeedback('Notifica√ß√µes n√£o suportadas neste navegador', 'warning');
            currentSettings.pushNotifications = false;
            setElementValue('pushNotifications', false);
            saveSettings();
        }
    } else {
        showSettingsFeedback('Notifica√ß√µes push desativadas', 'info');
    }
}

/**
 * Toggle modo debug
 */
function toggleDebugMode(enabled) {
    if (enabled) {
        console.log('üêõ Modo debug ativado');
        window.DEBUG_MODE = true;
        showSettingsFeedback('Modo debug ativado - Console habilitado', 'info');
    } else {
        console.log('üêõ Modo debug desativado');
        window.DEBUG_MODE = false;
        showSettingsFeedback('Modo debug desativado', 'info');
    }
}

/**
 * Toggle modo performance
 */
function togglePerformanceMode(enabled) {
    if (enabled) {
        document.body.classList.add('performance-mode');
        showSettingsFeedback('Modo performance ativado', 'success');
    } else {
        document.body.classList.remove('performance-mode');
        showSettingsFeedback('Modo performance desativado', 'info');
    }
}

/**
 * Salvar configura√ß√µes no localStorage
 */
function saveSettings() {
    try {
        localStorage.setItem('settings', JSON.stringify(currentSettings));
        console.log('üíæ Configura√ß√µes salvas');
    } catch (error) {
        console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
        showSettingsFeedback('Erro ao salvar configura√ß√µes', 'error');
    }
}

/**
 * Aplicar configura√ß√µes visuais
 */
function applyVisualSettings() {
    // Aplicar modo escuro se ativado
    if (currentSettings.darkMode) {
        document.body.classList.add('theme-dark');
    }
    
    // Aplicar modo performance se ativado
    if (currentSettings.performanceMode) {
        document.body.classList.add('performance-mode');
    }
}

/**
 * Carregar estat√≠sticas das configura√ß√µes
 */
function loadSettingsStats() {
    try {
        // Obter dados de uso do localStorage
        const storageStats = getStorageStats();
        
        // Atualizar cards de status se existirem
        updateStatusCard('storageUsed', `${storageStats.usedFormatted} de dados salvos`);
        updateStatusCard('settingsCount', `${Object.keys(currentSettings).length} configura√ß√µes`);
        updateStatusCard('lastBackup', getLastBackupInfo());
        updateStatusCard('appVersion', getAppVersion());
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
    }
}

/**
 * Atualizar card de status
 */
function updateStatusCard(id, value) {
    const card = document.getElementById(id);
    if (card) {
        const valueElement = card.querySelector('.status-value');
        if (valueElement) {
            valueElement.textContent = value;
        }
    }
}

/**
 * Obter estat√≠sticas de storage
 */
function getStorageStats() {
    let used = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            used += localStorage[key].length;
        }
    }
    
    return {
        used: used,
        usedFormatted: formatBytes(used),
        available: '5MB', // Limite aproximado do localStorage
        percentUsed: Math.min((used / (5 * 1024 * 1024)) * 100, 100)
    };
}

/**
 * Formatar bytes em formato leg√≠vel
 */
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * Obter informa√ß√µes do √∫ltimo backup
 */
function getLastBackupInfo() {
    const lastBackup = localStorage.getItem('lastBackupDate');
    if (lastBackup) {
        const date = new Date(lastBackup);
        return date.toLocaleDateString('pt-BR');
    }
    return 'Nunca';
}

/**
 * Obter vers√£o da aplica√ß√£o
 */
function getAppVersion() {
    return 'v2.3.0'; // Vers√£o atual da aplica√ß√£o
}

/**
 * Limpar todos os dados
 */
function clearAllData() {
    const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover PERMANENTEMENTE:

‚Ä¢ Todas as configura√ß√µes personalizadas
‚Ä¢ Todos os c√°lculos salvos
‚Ä¢ Todos os or√ßamentos criados
‚Ä¢ Dados de perfil do usu√°rio
‚Ä¢ Cache de autocomplete
‚Ä¢ Hist√≥rico de notifica√ß√µes

Esta a√ß√£o N√ÉO PODE ser desfeita!

Digite "CONFIRMAR" para prosseguir:`;
    
    const confirmation = prompt(confirmMessage);
    
    if (confirmation === 'CONFIRMAR') {
        try {
            // Salvar algumas informa√ß√µes essenciais antes de limpar
            const userId = localStorage.getItem('currentUserId');
            
            // Limpar localStorage
            localStorage.clear();
            
            // Restaurar informa√ß√µes essenciais se necess√°rio
            if (userId) {
                localStorage.setItem('lastClearDate', new Date().toISOString());
            }
            
            showSettingsFeedback('Todos os dados foram removidos. Redirecionando...', 'success');
            
            // Redirecionar ap√≥s 2 segundos
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
            console.log('üóëÔ∏è Todos os dados foram limpos');
            
        } catch (error) {
            console.error('‚ùå Erro ao limpar dados:', error);
            showSettingsFeedback('Erro ao limpar dados', 'error');
        }
    } else {
        showSettingsFeedback('Limpeza de dados cancelada', 'info');
    }
}

/**
 * Exportar configura√ß√µes
 */
function exportSettings() {
    try {
        const exportData = {
            settings: currentSettings,
            exportDate: new Date().toISOString(),
            appVersion: getAppVersion(),
            userAgent: navigator.userAgent
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `calculadora-madeira-config-${new Date().toISOString().split('T')[0]}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSettingsFeedback('Configura√ß√µes exportadas com sucesso', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao exportar configura√ß√µes:', error);
        showSettingsFeedback('Erro ao exportar configura√ß√µes', 'error');
    }
}

/**
 * Importar configura√ß√µes
 */
function importSettings(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            
            if (importData.settings) {
                // Validar e mesclar configura√ß√µes
                const validSettings = validateSettings(importData.settings);
                currentSettings = { ...DEFAULT_SETTINGS, ...validSettings };
                
                // Salvar e aplicar
                saveSettings();
                applySettingsToUI();
                applyVisualSettings();
                
                showSettingsFeedback('Configura√ß√µes importadas com sucesso', 'success');
                
                console.log('üì• Configura√ß√µes importadas:', validSettings);
            } else {
                throw new Error('Formato de arquivo inv√°lido');
            }
        } catch (error) {
            console.error('‚ùå Erro ao importar configura√ß√µes:', error);
            showSettingsFeedback('Erro ao importar configura√ß√µes', 'error');
        }
    };
    
    reader.readAsText(file);
    
    // Limpar o input
    event.target.value = '';
}

/**
 * Validar configura√ß√µes importadas
 */
function validateSettings(settings) {
    const validSettings = {};
    
    for (const key in DEFAULT_SETTINGS) {
        if (settings.hasOwnProperty(key)) {
            const defaultType = typeof DEFAULT_SETTINGS[key];
            const importedType = typeof settings[key];
            
            if (defaultType === importedType) {
                validSettings[key] = settings[key];
            }
        }
    }
    
    return validSettings;
}

/**
 * Resetar para configura√ß√µes padr√£o
 */
function resetToDefaults() {
    if (confirm('‚ö†Ô∏è Deseja restaurar todas as configura√ß√µes para os valores padr√£o?')) {
        currentSettings = { ...DEFAULT_SETTINGS };
        saveSettings();
        applySettingsToUI();
        applyVisualSettings();
        
        showSettingsFeedback('Configura√ß√µes restauradas para padr√£o', 'success');
        
        console.log('üîÑ Configura√ß√µes resetadas para padr√£o');
    }
}

/**
 * Mostrar feedback de configura√ß√µes
 */
function showSettingsFeedback(message, type = 'success') {
    // Usar sistema de feedback global se dispon√≠vel
    if (typeof window.showFeedback === 'function') {
        window.showFeedback(message, type);
        return;
    }
    
    // Fallback simples
    console.log(`üì¢ Settings Feedback (${type}):`, message);
}

// Disponibilizar fun√ß√µes globalmente para compatibilidade
window.SettingsModule = {
    loadSettings,
    saveSettings,
    clearAllData,
    exportSettings,
    importSettings,
    resetToDefaults,
    getCurrentSettings: () => currentSettings,
    updateSetting: (key, value) => {
        currentSettings[key] = value;
        saveSettings();
        applySpecificSetting(key, value);
    }
};

// Disponibilizar fun√ß√£o espec√≠fica globalmente (para onclick se necess√°rio)
window.clearAllData = clearAllData;

// Verificar se DOM j√° carregou (fallback para compatibilidade)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üì¶ M√≥dulo de configura√ß√µes carregado (DOMContentLoaded)');
    });
} else {
    console.log('üì¶ M√≥dulo de configura√ß√µes carregado (DOM j√° pronto)');
} 